"use strict";function combine_array_buffers(e,t){var i,n=new Uint8Array(e),a=new Uint8Array(t),s=new ArrayBuffer(e.byteLength+t.byteLength),r=new Uint8Array(s),o=0;for(i=0;n.length>i;i++)r[o++]=n[i];for(i=0;a.length>i;i++)r[o++]=a[i];return s}function hexdump_buffer(e){for(var t=new Uint8Array(e),i="",n="",a=0,s=0;t.length>s;s++){var r=Number(t[s]).toString(16);if(1==r.length&&(i+="0"),i+=r+" ",n+=String.fromCharCode(t[s]),15==s%16||s==t.length-1){for(;15!=s%16;)i+="   ",s++;0==a&&console.log(i+" | "+n),"00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "==i?1==a?(console.log("."),a++):0==a&&a++:a=0,i=n=""}}}function get_scancode(e){return void 0===common_scanmap[e]?-1!=navigator.userAgent.indexOf("Firefox")?firefox_scanmap[e]:DOM_scanmap[e]:common_scanmap[e]}function keycode_to_start_scan(e){var t=get_scancode(e);return void 0===t?(alert("no map for "+e),0):256>t?t:224|t-256<<8}function keycode_to_end_scan(e){var t=get_scancode(e);return void 0===t?0:256>t?128|t:32992|t-256<<8}function rfc2083_make_crc_table(){var e,t,i;for(t=0;256>t;t++){for(e=t,i=0;8>i;i++)1&e?e=4294967295&(3988292384^e>>>1)>>>0:e>>>=1;rfc2083_crc_table[t]=e}rfc2083_crc_table_computed=1}function rfc2083_update_crc(e,t,i,n){var a,s=e;for(rfc2083_crc_table_computed||rfc2083_make_crc_table(),a=0;n>a;a++)s=rfc2083_crc_table[255&(s^t[i+a])]^s>>>8;return s}function rfc2083_crc(e,t,i){return 4294967295^rfc2083_update_crc(4294967295,e,t,i)}function crc32(e,t,i){var n=new Uint8Array(e);return rfc2083_crc(n,t,i)}function PngIHDR(e,t){this.width=e,this.height=t,this.depth=8,this.type=6,this.compression=0,this.filter=0,this.interlace=0}function adler(){this.s1=1,this.s2=0}function PngIDAT(e,t,i){if(i.byteLength>65535)throw new Error("Cannot handle more than 64K");this.data=i,this.width=e,this.height=t}function PngIEND(){}function create_rgba_png(e,t,i){var n,a=new PngIHDR(e,t),s=new PngIDAT(e,t,i),r=new PngIEND,o=new ArrayBuffer(a.buffer_size()+s.buffer_size()+r.buffer_size()),l=a.to_buffer(o);l=s.to_buffer(o,l),l=r.to_buffer(o,l);var c=new Uint8Array(o),u="";for(n=0;l>n;n++)u+="%",16>c[n]&&(u+="0"),u+=c[n].toString(16);return"%89PNG%0D%0A%1A%0A"+u}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function lz_rgb32_decompress(e,t,n,a,s){var r,o=t,l=0;for(r=e[o++];n.length>4*l;r=e[o++]){var c=l,u=r>>5,d=(31&r)<<8;if(r>=32){var h;if(u--,6==u)do h=e[o++],u+=h;while(255==h);if(h=e[o++],d+=h,255==h&&7936==d-h&&(d=e[o++]<<8,d+=e[o++],d+=8191),u+=1,a==LZ_IMAGE_TYPE_RGBA&&(u+=2),d+=1,c-=d,c==l-1)for(var p=c;u;--u){if(a==LZ_IMAGE_TYPE_RGBA)n[4*l+3]=n[4*p+3];else for(i=0;4>i;i++)n[4*l+i]=n[4*p+i];l++}else for(;u;--u){if(a==LZ_IMAGE_TYPE_RGBA)n[4*l+3]=n[4*c+3];else for(i=0;4>i;i++)n[4*l+i]=n[4*c+i];l++,c++}}else for(r++,a==LZ_IMAGE_TYPE_RGBA?n[4*l+3]=e[o++]:(n[4*l+0]=e[o+2],n[4*l+1]=e[o+1],n[4*l+2]=e[o+0],s&&(n[4*l+3]=255),o+=3),l++,--r;r;r--)a==LZ_IMAGE_TYPE_RGBA?n[4*l+3]=e[o++]:(n[4*l+0]=e[o+2],n[4*l+1]=e[o+1],n[4*l+2]=e[o+0],s&&(n[4*l+3]=255),o+=3),l++}return o-1}function convert_spice_lz_to_web(e,t){var i;if(t.type===LZ_IMAGE_TYPE_RGB32||t.type===LZ_IMAGE_TYPE_RGBA){var n=new Uint8Array(t.data),a=e.createImageData(t.width,t.height);i=lz_rgb32_decompress(n,0,a.data,LZ_IMAGE_TYPE_RGB32,t.type!=LZ_IMAGE_TYPE_RGBA),t.type==LZ_IMAGE_TYPE_RGBA&&lz_rgb32_decompress(n,i,a.data,LZ_IMAGE_TYPE_RGBA,!1)}else{if(t.type!==LZ_IMAGE_TYPE_XXXA)return void 0;var n=new Uint8Array(t.data),a=e.createImageData(t.width,t.height);lz_rgb32_decompress(n,0,a.data,LZ_IMAGE_TYPE_RGBA,!1)}return a}function ceil_log_2(e){if(1===e)return 0;var t=1;for(e-=1;e>>>=1;)t++;return t}function family_init(e,t,i){var n;for(n=0;t>n;n++){var a,s;a=i-t,a>bppmask[t-n]&&(a=bppmask[t-n]),s=bppmask[t]+1-(a<<n),e.nGRcodewords[n]=a<<n,e.notGRcwlen[n]=a+ceil_log_2(s),e.notGRprefixmask[n]=bppmask[32-a]>>>0,e.notGRsuffixlen[n]=ceil_log_2(s)}var r,o=bppmask[t],l=o>>>1;for(r=0;o>=r;r++)e.xlatU2L[r]=l>=r?r<<1:(o-r<<1)+1;for(r=0;o>=r;r++)e.xlatL2U[r]=1&r?o-(r>>>1):r>>>1}function quic_image_bpc(e){switch(e){case QUIC_IMAGE_TYPE_GRAY:return 8;case QUIC_IMAGE_TYPE_RGB16:return 5;case QUIC_IMAGE_TYPE_RGB24:return 8;case QUIC_IMAGE_TYPE_RGB32:return 8;case QUIC_IMAGE_TYPE_RGBA:return 8;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),0}}function cnt_l_zeroes(e){return 4286578688&e?lzeroes[e>>>24]:4294934528&e?8+lzeroes[255&e>>>16]:4294967168&e?16+lzeroes[255&e>>>8]:24+lzeroes[255&e]}function golomb_decoding_8bpc(e,t){var i,n;if(0>t||t>family_8bpc.notGRprefixmask[e]){var a=cnt_l_zeroes(t);n=a+1+e,i=a<<e|t>>32-n&bppmask[e]}else n=family_8bpc.notGRcwlen[e],i=family_8bpc.nGRcodewords[e]+(t>>32-n&bppmask[family_8bpc.notGRsuffixlen[e]]);return{codewordlen:n,rc:i}}function golomb_code_len_8bpc(e,t){return family_8bpc.nGRcodewords[t]>e?(e>>>t)+1+t:family_8bpc.notGRcwlen[t]}function QuicModel(e){var t,i=0;switch(this.levels=1<<e,this.n_buckets_ptrs=0,evol){case 1:this.repfirst=3,this.firstsize=1,this.repnext=2,this.mulsize=2;break;case 3:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=2;break;case 5:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=4;break;case 0:case 2:case 4:console.log("quic: findmodelparams(): evol value obsolete!!!\n");default:console.log("quic: findmodelparams(): evol out of range!!!\n")}this.n_buckets=0;var n=this.repfirst+1,a=this.firstsize;do t=this.n_buckets?i+1:0,--n||(n=this.repnext,a*=this.mulsize),i=t+a-1,i+a>=this.levels&&(i=this.levels-1),this.n_buckets_ptrs||(this.n_buckets_ptrs=this.levels),this.n_buckets++;while(this.levels-1>i)}function QuicBucket(){this.counters=[0,0,0,0,0,0,0,0]}function QuicFamilyStat(){this.buckets_ptrs=[],this.buckets_buf=[]}function QuicChannel(e,t){return this.state=new CommonState,this.family_stat_8bpc=new QuicFamilyStat,this.family_stat_5bpc=new QuicFamilyStat,this.correlate_row={zero:0,row:[]},this.model_8bpc=e,this.model_5bpc=t,this.buckets_ptrs=[],this.family_stat_8bpc.fill_model_structures(this.model_8bpc)?this.family_stat_5bpc.fill_model_structures(this.model_5bpc)?void 0:void 0:void 0}function CommonState(){}function QuicEncoder(){this.rgb_state=new CommonState,this.model_8bpc=new QuicModel(8),this.model_5bpc=new QuicModel(5),this.channels=[];var e;for(e=0;4>e;e++)if(this.channels[e]=new QuicChannel(this.model_8bpc,this.model_5bpc),!this.channels[e])return console.log("quic: failed to create channel"),void 0}function SpiceQuic(){}function convert_spice_quic_to_web(e,t){var i,n=e.createImageData(t.width,t.height);for(i=0;4*n.width*n.height>i;i+=4)n.data[i+0]=t.outptr[i+2],n.data[i+1]=t.outptr[i+1],n.data[i+2]=t.outptr[i+0],n.data[i+3]=t.type!==QUIC_IMAGE_TYPE_RGBA?255:255-t.outptr[i+3];return n}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function convert_spice_bitmap_to_web(e,t){var i,n,a,s=new Uint8Array(t.data);if(t.format!=SPICE_BITMAP_FMT_32BIT&&t.format!=SPICE_BITMAP_FMT_RGBA)return void 0;for(i=e.createImageData(t.x,t.y),n=0;t.y*t.stride>n;)for(a=0;t.x>a;a++,n+=4)i.data[n+0]=s[n+2],i.data[n+1]=s[n+1],i.data[n+2]=s[n+0],i.data[n+3]=t.format==SPICE_BITMAP_FMT_32BIT?255:s[n];return i}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceDataView(e,t,i){this.u8=void 0!==t?void 0!==i?new Uint8Array(e,t,i):new Uint8Array(e,t):new Uint8Array(e)}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceChannelId(){}function SpiceRect(){}function SpiceClipRects(){}function SpiceClip(){}function SpiceImageDescriptor(){}function SpicePalette(){}function SpiceBitmap(){}function SpiceImage(){}function SpiceQMask(){}function SpicePattern(){}function SpiceBrush(){}function SpiceFill(){}function SpiceCopy(){}function SpicePoint16(){}function SpicePoint(){}function SpiceCursorHeader(){}function SpiceCursor(){}function SpiceSurface(){}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceLinkHeader(e,t){this.magic=SPICE_MAGIC,this.major_version=SPICE_VERSION_MAJOR,this.minor_version=SPICE_VERSION_MINOR,this.size=0,void 0!==e&&this.from_buffer(e,t)}function SpiceLinkMess(e,t){this.connection_id=0,this.channel_type=0,this.channel_id=0,this.common_caps=[],this.channel_caps=[],void 0!==e&&this.from_buffer(e,t)}function SpiceLinkReply(e,t){this.error=0,this.pub_key=void 0,this.common_caps=[],this.channel_caps=[],void 0!==e&&this.from_buffer(e,t)}function SpiceLinkAuthTicket(){this.auth_mechanism=0,this.encrypted_data=void 0}function SpiceLinkAuthReply(e,t){this.auth_code=0,void 0!==e&&this.from_buffer(e,t)}function SpiceMiniData(e,t){this.type=0,this.size=0,this.data=void 0,void 0!==e&&this.from_buffer(e,t)}function SpiceMsgChannels(e,t){this.num_of_channels=0,this.channels=[],void 0!==e&&this.from_buffer(e,t)}function SpiceMsgMainInit(e,t){this.from_buffer(e,t)}function SpiceMsgMainMouseMode(e,t){this.from_buffer(e,t)}function SpiceMsgSetAck(e,t){this.from_buffer(e,t)}function SpiceMsgcAckSync(e){this.generation=e.generation}function SpiceMsgcMainMouseModeRequest(e){this.mode=e}function SpiceMsgNotify(e,t){this.from_buffer(e,t)}function SpiceMsgcDisplayInit(){this.pixmap_cache_id=1,this.glz_dictionary_id=0,this.pixmap_cache_size=10485760,this.glz_dictionary_window_size=0}function SpiceMsgDisplayBase(){}function SpiceMsgDisplayDrawCopy(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayDrawFill(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayCopyBits(e,t){this.from_buffer(e,t)}function SpiceMsgSurfaceCreate(e,t){this.from_buffer(e,t)}function SpiceMsgSurfaceDestroy(e,t){this.from_buffer(e,t)}function SpiceMsgInputsInit(e,t){this.from_buffer(e,t)}function SpiceMsgInputsKeyModifiers(e,t){this.from_buffer(e,t)}function SpiceMsgCursorInit(e,t){this.from_buffer(e,t)}function SpiceMsgCursorSet(e,t){this.from_buffer(e,t)}function SpiceMsgcMousePosition(e,t){this.display_id=0,this.buttons_state=e.buttons_state,t?(this.x=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft+document.body.scrollLeft,this.y=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop+document.body.scrollTop,e.mousex=this.x,e.mousey=this.y):this.x=this.y=this.buttons_state=0}function SpiceMsgcMouseMotion(e,t){this.display_id=0,this.buttons_state=e.buttons_state,t?(this.x=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft,this.y=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop,void 0!==e.mousex&&(this.x-=e.mousex,this.y-=e.mousey),e.mousex=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft,e.mousey=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop):this.x=this.y=this.buttons_state=0}function SpiceMsgcMousePress(e,t){t?(this.button=t.button+1,this.buttons_state=1<<t.button,e.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=SPICE_MOUSE_BUTTON_MASK_LEFT)}function SpiceMsgcMouseRelease(e,t){t?(this.button=t.button+1,this.buttons_state=0,e.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=0)}function SpiceMsgcKeyDown(e){this.code=e?keycode_to_start_scan(e.keyCode):0}function SpiceMsgcKeyUp(e){this.code=e?keycode_to_end_scan(e.keyCode):0}function SpiceMsgDisplayStreamCreate(e,t){this.from_buffer(e,t)}function SpiceStreamDataHeader(){}function SpiceMsgDisplayStreamData(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamClip(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamDestroy(e,t){this.from_buffer(e,t)}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceWireReader(e,t){this.sc=e,this.callback=t,this.needed=0,this.buffers=[],this.sc.ws.wire_reader=this,this.sc.ws.binaryType="arraybuffer",this.sc.ws.addEventListener("message",wire_blob_catcher)}function wire_blob_catcher(e){DEBUG>1&&console.log(">> WebSockets.onmessage"),DEBUG>1&&console.log("id "+this.wire_reader.sc.connection_id+"; type "+this.wire_reader.sc.type),SpiceWireReader.prototype.inbound.call(this.wire_reader,e.data)}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceConn(e){if(void 0===e||void 0===e.uri||!e.uri)throw new Error("You must specify a uri");if(this.ws=new WebSocket(e.uri,"binary"),!this.ws.binaryType)throw new Error("WebSocket doesn't support binaryType.  Try a different browser.");if(this.connection_id=void 0!==e.connection_id?e.connection_id:0,this.type=void 0!==e.type?e.type:SPICE_CHANNEL_MAIN,this.chan_id=void 0!==e.chan_id?e.chan_id:0,void 0!==e.parent&&(this.parent=e.parent,this.message_id=e.parent.message_id,this.password=e.parent.password),void 0!==e.screen_id&&(this.screen_id=e.screen_id),void 0!==e.dump_id&&(this.dump_id=e.dump_id),void 0!==e.message_id&&(this.message_id=e.message_id),void 0!==e.password&&(this.password=e.password),void 0!==e.onerror&&(this.onerror=e.onerror),void 0!==e.onsuccess&&(this.onsuccess=e.onsuccess),this.state="connecting",this.ws.parent=this,this.wire_reader=new SpiceWireReader(this,this.process_inbound),this.messages_sent=0,this.warnings=[],this.ws.addEventListener("open",function(){DEBUG>0&&console.log(">> WebSockets.onopen"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),this.parent.send_hdr(),this.parent.wire_reader.request(SpiceLinkHeader.prototype.buffer_size()),this.parent.state="start"}),this.ws.addEventListener("error",function(e){this.parent.log_err(">> WebSockets.onerror"+e.toString()),this.parent.report_error(e)}),this.ws.addEventListener("close",function(e){if(DEBUG>0&&console.log(">> WebSockets.onclose"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),DEBUG>0&&console.log(e),"closing"!=this.parent.state&&"error"!=this.parent.state&&void 0!==this.parent.onerror){var e;e="connecting"==this.parent.state?new Error("Connection refused."):"start"==this.parent.state||"link"==this.parent.state?new Error("Unexpected protocol mismatch."):"ticket"==this.parent.state?new Error("Bad password."):new Error("Unexpected close while "+this.parent.state),this.parent.onerror(e),this.parent.log_err(e.toString())}}),2==this.ws.readyState||3==this.ws.readyState)throw new Error("Unable to connect to "+e.uri);this.timeout=window.setTimeout(spiceconn_timeout,SPICE_CONNECT_TIMEOUT,this)}function spiceconn_timeout(e){SpiceConn.prototype.handle_timeout.call(e)}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function putImageDataWithAlpha(e,t,i,n){var a=document.createElement("canvas"),s=a.getContext("2d");a.setAttribute("width",t.width),a.setAttribute("height",t.height),s.putImageData(t,0,0),e.drawImage(a,i,n,t.width,t.height)}function stripAlpha(e){var t;for(t=0;4*e.width*e.height>t;t+=4)e.data[t+3]=255}function SpiceDisplayConn(){SpiceConn.apply(this,arguments)}function handle_mouseover(){this.focus()}function handle_mouseout(){this.blur()}function handle_draw_jpeg_onload(){var e,t=null;if(void 0===this.o.sc.surfaces[this.o.base.surface_id]?(DEBUG>2&&this.o.sc.log_info("Discarding jpeg; presumed lost surface "+this.o.base.surface_id),t=document.createElement("canvas"),t.setAttribute("width",this.o.base.box.right),t.setAttribute("height",this.o.base.box.bottom),e=t.getContext("2d")):e=this.o.sc.surfaces[this.o.base.surface_id].canvas.context,this.alpha_img){var i=document.createElement("canvas"),n=i.getContext("2d");i.setAttribute("width",this.alpha_img.width),i.setAttribute("height",this.alpha_img.height),n.putImageData(this.alpha_img,0,0),n.globalCompositeOperation="source-in",n.drawImage(this,0,0),e.drawImage(i,this.o.base.box.left,this.o.base.box.top),this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache=[]),this.o.sc.cache[this.o.descriptor.id]=n.getImageData(0,0,this.alpha_img.width,this.alpha_img.height))}else e.drawImage(this,this.o.base.box.left,this.o.base.box.top),this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache=[]),this.o.sc.cache[this.o.descriptor.id]=e.getImageData(this.o.base.box.left,this.o.base.box.top,this.o.base.box.right-this.o.base.box.left,this.o.base.box.bottom-this.o.base.box.top));if(null==t){if(DUMP_DRAWS&&this.o.sc.parent.dump_id){var a=document.createElement("canvas");a.setAttribute("id",this.o.tag+"."+this.o.sc.surfaces[this.o.base.surface_id].draw_count+"."+this.o.base.surface_id+"@"+this.o.base.box.left+"x"+this.o.base.box.top),a.getContext("2d").drawImage(this,0,0),document.getElementById(this.o.sc.parent.dump_id).appendChild(a)}this.o.sc.surfaces[this.o.base.surface_id].draw_count++}}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceMainConn(){if("undefined"==typeof WebSocket)throw new Error("WebSocket unavailable.  You need to use a different browser.");SpiceConn.apply(this,arguments)}function SpiceInputsConn(){SpiceConn.apply(this,arguments),this.mousex=void 0,this.mousey=void 0,this.button_state=0,this.waiting_for_ack=0}function handle_mousemove(e){var t,i=new SpiceMiniData;this.sc.mouse_mode==SPICE_MOUSE_MODE_CLIENT?(t=new SpiceMsgcMousePosition(this.sc,e),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_POSITION,t)):(t=new SpiceMsgcMouseMotion(this.sc,e),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_MOTION,t)),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&(2*SPICE_INPUT_MOTION_ACK_BUNCH>this.sc.inputs.waiting_for_ack?(this.sc.inputs.send_msg(i),this.sc.inputs.waiting_for_ack++):DEBUG>0&&this.sc.log_info("Discarding mouse motion"))}function handle_mousedown(e){var t=new SpiceMsgcMousePress(this.sc,e),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_contextmenu(e){return e.preventDefault(),!1}function handle_mouseup(e){var t=new SpiceMsgcMouseRelease(this.sc,e),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_mousewheel(e){var t=new SpiceMsgcMousePress,i=new SpiceMsgcMouseRelease;t.button=i.button=e.wheelDelta>0?SPICE_MOUSE_BUTTON_UP:SPICE_MOUSE_BUTTON_DOWN,t.buttons_state=0,i.buttons_state=0;var n=new SpiceMiniData;n.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(n),n.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,i),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(n),e.preventDefault()}function handle_keydown(e){var t=new SpiceMsgcKeyDown(e),i=new SpiceMiniData;check_and_update_modifiers(e,t.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_keyup(e){var t=new SpiceMsgcKeyUp(e),i=new SpiceMiniData;check_and_update_modifiers(e,t.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_UP,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function sendCtrlAltDel(){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var e=new SpiceMsgcKeyDown,t=new SpiceMiniData;update_modifier(!0,KEY_LCtrl,sc),update_modifier(!0,KEY_Alt,sc),e.code=KEY_KP_Decimal,t.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,e),sc.inputs.send_msg(t),t.build_msg(SPICE_MSGC_INPUTS_KEY_UP,e),sc.inputs.send_msg(t),0==Ctrl_state&&update_modifier(!1,KEY_LCtrl,sc),0==Alt_state&&update_modifier(!1,KEY_Alt,sc)}}function update_modifier(e,t,i){var n=new SpiceMiniData;if(e){var a=new SpiceMsgcKeyDown;a.code=t,n.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,a)}else{var a=new SpiceMsgcKeyUp;a.code=128|t,n.build_msg(SPICE_MSGC_INPUTS_KEY_UP,a)}i.inputs.send_msg(n)}function check_and_update_modifiers(e,t,i){-1===Shift_state&&(Shift_state=e.shiftKey,Ctrl_state=e.ctrlKey,Alt_state=e.altKey,Meta_state=e.metaKey),t===KEY_ShiftL?Shift_state=!0:t===KEY_Alt?Alt_state=!0:t===KEY_LCtrl?Ctrl_state=!0:57525===t?Meta_state=!0:t===(128|KEY_ShiftL)?Shift_state=!1:t===(128|KEY_Alt)?Alt_state=!1:t===(128|KEY_LCtrl)?Ctrl_state=!1:57525===t&&(Meta_state=!1),i&&i.inputs&&"ready"===i.inputs.state&&(Shift_state!=e.shiftKey&&(console.log("Shift state out of sync"),update_modifier(e.shiftKey,KEY_ShiftL,i),Shift_state=e.shiftKey),Alt_state!=e.altKey&&(console.log("Alt state out of sync"),update_modifier(e.altKey,KEY_Alt,i),Alt_state=e.altKey),Ctrl_state!=e.ctrlKey&&(console.log("Ctrl state out of sync"),update_modifier(e.ctrlKey,KEY_LCtrl,i),Ctrl_state=e.ctrlKey),Meta_state!=e.metaKey&&(console.log("Meta state out of sync"),update_modifier(e.metaKey,57525,i),Meta_state=e.metaKey))}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceCursorConn(){SpiceConn.apply(this,arguments)}function BigInteger(e,t,i){null!=e&&("number"==typeof e?this.fromNumber(e,t,i):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function nbi(){return new BigInteger(null)}function am1(e,t,i,n,a,s){for(;--s>=0;){var r=t*this[e++]+i[n]+a;a=Math.floor(r/67108864),i[n++]=67108863&r}return a}function am2(e,t,i,n,a,s){for(var r=32767&t,o=t>>15;--s>=0;){var l=32767&this[e],c=this[e++]>>15,u=o*l+c*r;l=r*l+((32767&u)<<15)+i[n]+(1073741823&a),a=(l>>>30)+(u>>>15)+o*c+(a>>>30),i[n++]=1073741823&l}return a}function am3(e,t,i,n,a,s){for(var r=16383&t,o=t>>14;--s>=0;){var l=16383&this[e],c=this[e++]>>14,u=o*l+c*r;l=r*l+((16383&u)<<14)+i[n]+a,a=(l>>28)+(u>>14)+o*c,i[n++]=268435455&l}return a}function int2char(e){return BI_RM.charAt(e)}function intAt(e,t){var i=BI_RC[e.charCodeAt(t)];return null==i?-1:i}function bnpCopyTo(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function bnpFromInt(e){this.t=1,this.s=0>e?-1:0,e>0?this[0]=e:-1>e?this[0]=e+DV:this.t=0}function nbv(e){var t=nbi();return t.fromInt(e),t}function bnpFromString(e,t){var i;if(16==t)i=4;else if(8==t)i=3;else if(256==t)i=8;else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return this.fromRadix(e,t),void 0;i=2}this.t=0,this.s=0;for(var n=e.length,a=!1,s=0;--n>=0;){var r=8==i?255&e[n]:intAt(e,n);0>r?"-"==e.charAt(n)&&(a=!0):(a=!1,0==s?this[this.t++]=r:s+i>this.DB?(this[this.t-1]|=(r&(1<<this.DB-s)-1)<<s,this[this.t++]=r>>this.DB-s):this[this.t-1]|=r<<s,s+=i,s>=this.DB&&(s-=this.DB))}8==i&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),a&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t}function bnToString(e){if(0>this.s)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var i,n=(1<<t)-1,a=!1,s="",r=this.t,o=this.DB-r*this.DB%t;if(r-->0)for(this.DB>o&&(i=this[r]>>o)>0&&(a=!0,s=int2char(i));r>=0;)t>o?(i=(this[r]&(1<<o)-1)<<t-o,i|=this[--r]>>(o+=this.DB-t)):(i=this[r]>>(o-=t)&n,0>=o&&(o+=this.DB,--r)),i>0&&(a=!0),a&&(s+=int2char(i));return a?s:"0"}function bnNegate(){var e=nbi();return BigInteger.ZERO.subTo(this,e),e}function bnAbs(){return 0>this.s?this.negate():this}function bnCompareTo(e){var t=this.s-e.s;if(0!=t)return t;var i=this.t;if(t=i-e.t,0!=t)return t;for(;--i>=0;)if(0!=(t=this[i]-e[i]))return t;return 0}function nbits(e){var t,i=1;return 0!=(t=e>>>16)&&(e=t,i+=16),0!=(t=e>>8)&&(e=t,i+=8),0!=(t=e>>4)&&(e=t,i+=4),0!=(t=e>>2)&&(e=t,i+=2),0!=(t=e>>1)&&(e=t,i+=1),i}function bnBitLength(){return 0>=this.t?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(e,t){var i;for(i=this.t-1;i>=0;--i)t[i+e]=this[i];for(i=e-1;i>=0;--i)t[i]=0;t.t=this.t+e,t.s=this.s}function bnpDRShiftTo(e,t){for(var i=e;this.t>i;++i)t[i-e]=this[i];t.t=Math.max(this.t-e,0),t.s=this.s}function bnpLShiftTo(e,t){var i,n=e%this.DB,a=this.DB-n,s=(1<<a)-1,r=Math.floor(e/this.DB),o=this.s<<n&this.DM;for(i=this.t-1;i>=0;--i)t[i+r+1]=this[i]>>a|o,o=(this[i]&s)<<n;for(i=r-1;i>=0;--i)t[i]=0;t[r]=o,t.t=this.t+r+1,t.s=this.s,t.clamp()}function bnpRShiftTo(e,t){t.s=this.s;var i=Math.floor(e/this.DB);if(i>=this.t)return t.t=0,void 0;var n=e%this.DB,a=this.DB-n,s=(1<<n)-1;t[0]=this[i]>>n;for(var r=i+1;this.t>r;++r)t[r-i-1]|=(this[r]&s)<<a,t[r-i]=this[r]>>n;n>0&&(t[this.t-i-1]|=(this.s&s)<<a),t.t=this.t-i,t.clamp()}function bnpSubTo(e,t){for(var i=0,n=0,a=Math.min(e.t,this.t);a>i;)n+=this[i]-e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;this.t>i;)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;e.t>i;)n-=e[i],t[i++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=0>n?-1:0,-1>n?t[i++]=this.DV+n:n>0&&(t[i++]=n),t.t=i,t.clamp()}function bnpMultiplyTo(e,t){var i=this.abs(),n=e.abs(),a=i.t;for(t.t=a+n.t;--a>=0;)t[a]=0;for(a=0;n.t>a;++a)t[a+i.t]=i.am(0,n[a],t,a,0,i.t);t.s=0,t.clamp(),this.s!=e.s&&BigInteger.ZERO.subTo(t,t)}function bnpSquareTo(e){for(var t=this.abs(),i=e.t=2*t.t;--i>=0;)e[i]=0;for(i=0;t.t-1>i;++i){var n=t.am(i,t[i],e,2*i,0,1);(e[i+t.t]+=t.am(i+1,2*t[i],e,2*i+1,n,t.t-i-1))>=t.DV&&(e[i+t.t]-=t.DV,e[i+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(i,t[i],e,2*i,0,1)),e.s=0,e.clamp()}function bnpDivRemTo(e,t,i){var n=e.abs();if(!(0>=n.t)){var a=this.abs();if(a.t<n.t)return null!=t&&t.fromInt(0),null!=i&&this.copyTo(i),void 0;null==i&&(i=nbi());var s=nbi(),r=this.s,o=e.s,l=this.DB-nbits(n[n.t-1]);l>0?(n.lShiftTo(l,s),a.lShiftTo(l,i)):(n.copyTo(s),a.copyTo(i));var c=s.t,u=s[c-1];if(0!=u){var d=u*(1<<this.F1)+(c>1?s[c-2]>>this.F2:0),h=this.FV/d,p=(1<<this.F1)/d,f=1<<this.F2,m=i.t,_=m-c,g=null==t?nbi():t;for(s.dlShiftTo(_,g),i.compareTo(g)>=0&&(i[i.t++]=1,i.subTo(g,i)),BigInteger.ONE.dlShiftTo(c,g),g.subTo(s,s);c>s.t;)s[s.t++]=0;for(;--_>=0;){var b=i[--m]==u?this.DM:Math.floor(i[m]*h+(i[m-1]+f)*p);if(b>(i[m]+=s.am(0,b,i,_,0,c)))for(s.dlShiftTo(_,g),i.subTo(g,i);i[m]<--b;)i.subTo(g,i)}null!=t&&(i.drShiftTo(c,t),r!=o&&BigInteger.ZERO.subTo(t,t)),i.t=c,i.clamp(),l>0&&i.rShiftTo(l,i),0>r&&BigInteger.ZERO.subTo(i,i)}}}function bnMod(e){var t=nbi();return this.abs().divRemTo(e,null,t),0>this.s&&t.compareTo(BigInteger.ZERO)>0&&e.subTo(t,t),t}function Classic(e){this.m=e}function cConvert(e){return 0>e.s||e.compareTo(this.m)>=0?e.mod(this.m):e}function cRevert(e){return e}function cReduce(e){e.divRemTo(this.m,null,e)}function cMulTo(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function cSqrTo(e,t){e.squareTo(t),this.reduce(t)}function bnpInvDigit(){if(1>this.t)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return t=15&t*(2-(15&e)*t),t=255&t*(2-(255&e)*t),t=65535&t*(2-(65535&(65535&e)*t)),t=t*(2-e*t%this.DV)%this.DV,t>0?this.DV-t:-t}function Montgomery(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function montConvert(e){var t=nbi();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),0>e.s&&t.compareTo(BigInteger.ZERO)>0&&this.m.subTo(t,t),t}function montRevert(e){var t=nbi();return e.copyTo(t),this.reduce(t),t}function montReduce(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;this.m.t>t;++t){var i=32767&e[t],n=i*this.mpl+((i*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(i=t+this.m.t,e[i]+=this.m.am(0,n,e,t,0,this.m.t);e[i]>=e.DV;)e[i]-=e.DV,e[++i]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function montSqrTo(e,t){e.squareTo(t),this.reduce(t)}function montMulTo(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(e,t){if(e>4294967295||1>e)return BigInteger.ONE;var i=nbi(),n=nbi(),a=t.convert(this),s=nbits(e)-1;for(a.copyTo(i);--s>=0;)if(t.sqrTo(i,n),(e&1<<s)>0)t.mulTo(n,a,i);else{var r=i;i=n,n=r}return t.revert(i)}function bnModPowInt(e,t){var i;return i=256>e||t.isEven()?new Classic(t):new Montgomery(t),this.exp(e,i)}/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
function parseBigInt(e,t){return new BigInteger(e,t)}function linebrk(e,t){for(var i="",n=0;e.length>n+t;)i+=e.substring(n,n+t)+"\n",n+=t;return i+e.substring(n,e.length)}function byte2Hex(e){return 16>e?"0"+e.toString(16):e.toString(16)}function pkcs1pad2(e,t){if(e.length+11>t)return alert("Message too long for RSA"),null;for(var i=new Array,n=e.length-1;n>=0&&t>0;){var a=e.charCodeAt(n--);128>a?i[--t]=a:a>127&&2048>a?(i[--t]=128|63&a,i[--t]=192|a>>6):(i[--t]=128|63&a,i[--t]=128|63&a>>6,i[--t]=224|a>>12)}i[--t]=0;for(var s=new SecureRandom,r=new Array;t>2;){for(r[0]=0;0==r[0];)s.nextBytes(r);i[--t]=r[0]}return i[--t]=2,i[--t]=0,new BigInteger(i)}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(e,t){null!=e&&null!=t&&e.length>0&&t.length>0?(this.n=parseBigInt(e,16),this.e=parseInt(t,16)):alert("Invalid RSA public key")}function RSADoPublic(e){return e.modPowInt(this.e,this.n)}function RSAEncrypt(e){var t=pkcs1pad2(e,this.n.bitLength()+7>>3);if(null==t)return null;var i=this.doPublic(t);if(null==i)return null;var n=i.toString(16);return 0==(1&n.length)?n:"0"+n}/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
function Arcfour(){this.i=0,this.j=0,this.S=new Array}function ARC4init(e){var t,i,n;for(t=0;256>t;++t)this.S[t]=t;for(i=0,t=0;256>t;++t)i=255&i+this.S[t]+e[t%e.length],n=this.S[t],this.S[t]=this.S[i],this.S[i]=n;this.i=0,this.j=0}function ARC4next(){var e;return this.i=255&this.i+1,this.j=255&this.j+this.S[this.i],e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[255&e+this.S[this.i]]}function prng_newstate(){return new Arcfour}function rng_seed_int(e){rng_pool[rng_pptr++]^=255&e,rng_pool[rng_pptr++]^=255&e>>8,rng_pool[rng_pptr++]^=255&e>>16,rng_pool[rng_pptr++]^=255&e>>24,rng_pptr>=rng_psize&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),rng_state=prng_newstate(),rng_state.init(rng_pool),rng_pptr=0;rng_pool.length>rng_pptr;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(e){var t;for(t=0;e.length>t;++t)e[t]=rng_get_byte()}function SecureRandom(){}function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function b64_sha1(e){return rstr2b64(rstr_sha1(str2rstr_utf8(e)))}function any_sha1(e,t){return rstr2any(rstr_sha1(str2rstr_utf8(e)),t)}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function b64_hmac_sha1(e,t){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function any_hmac_sha1(e,t,i){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)),i)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var i=rstr2binb(e);i.length>16&&(i=binb_sha1(i,8*e.length));for(var n=Array(16),a=Array(16),s=0;16>s;s++)n[s]=909522486^i[s],a[s]=1549556828^i[s];var r=binb_sha1(n.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(a.concat(r),672))}function rstr2hex(e){try{}catch(t){hexcase=0}for(var i,n=hexcase?"0123456789ABCDEF":"0123456789abcdef",a="",s=0;e.length>s;s++)i=e.charCodeAt(s),a+=n.charAt(15&i>>>4)+n.charAt(15&i);return a}function rstr2b64(e){try{}catch(t){b64pad=""}for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",a=e.length,s=0;a>s;s+=3)for(var r=e.charCodeAt(s)<<16|(a>s+1?e.charCodeAt(s+1)<<8:0)|(a>s+2?e.charCodeAt(s+2):0),o=0;4>o;o++)n+=8*s+6*o>8*e.length?b64pad:i.charAt(63&r>>>6*(3-o));return n}function rstr2any(e,t){var i,n,a,s,r=t.length,o=Array(),l=Array(Math.ceil(e.length/2));for(i=0;l.length>i;i++)l[i]=e.charCodeAt(2*i)<<8|e.charCodeAt(2*i+1);for(;l.length>0;){for(s=Array(),a=0,i=0;l.length>i;i++)a=(a<<16)+l[i],n=Math.floor(a/r),a-=n*r,(s.length>0||n>0)&&(s[s.length]=n);o[o.length]=a,l=s}var c="";for(i=o.length-1;i>=0;i--)c+=t.charAt(o[i]);var u=Math.ceil(8*e.length/(Math.log(t.length)/Math.log(2)));for(i=c.length;u>i;i++)c=t[0]+c;return c}function str2rstr_utf8(e){for(var t,i,n="",a=-1;++a<e.length;)t=e.charCodeAt(a),i=e.length>a+1?e.charCodeAt(a+1):0,t>=55296&&56319>=t&&i>=56320&&57343>=i&&(t=65536+((1023&t)<<10)+(1023&i),a++),127>=t?n+=String.fromCharCode(t):2047>=t?n+=String.fromCharCode(192|31&t>>>6,128|63&t):65535>=t?n+=String.fromCharCode(224|15&t>>>12,128|63&t>>>6,128|63&t):2097151>=t&&(n+=String.fromCharCode(240|7&t>>>18,128|63&t>>>12,128|63&t>>>6,128|63&t));return n}function str2rstr_utf16le(e){for(var t="",i=0;e.length>i;i++)t+=String.fromCharCode(255&e.charCodeAt(i),255&e.charCodeAt(i)>>>8);return t}function str2rstr_utf16be(e){for(var t="",i=0;e.length>i;i++)t+=String.fromCharCode(255&e.charCodeAt(i)>>>8,255&e.charCodeAt(i));return t}function rstr2binb(e){for(var t=Array(e.length>>2),i=0;t.length>i;i++)t[i]=0;for(var i=0;8*e.length>i;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<24-i%32;return t}function binb2rstr(e){for(var t="",i=0;32*e.length>i;i+=8)t+=String.fromCharCode(255&e[i>>5]>>>24-i%32);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;for(var i=Array(80),n=1732584193,a=-271733879,s=-1732584194,r=271733878,o=-1009589776,l=0;e.length>l;l+=16){for(var c=n,u=a,d=s,h=r,p=o,f=0;80>f;f++){i[f]=16>f?e[l+f]:bit_rol(i[f-3]^i[f-8]^i[f-14]^i[f-16],1);var m=safe_add(safe_add(bit_rol(n,5),sha1_ft(f,a,s,r)),safe_add(safe_add(o,i[f]),sha1_kt(f)));o=r,r=s,s=bit_rol(a,30),a=n,n=m}n=safe_add(n,c),a=safe_add(a,u),s=safe_add(s,d),r=safe_add(r,h),o=safe_add(o,p)}return Array(n,a,s,r,o)}function sha1_ft(e,t,i,n){return 20>e?t&i|~t&n:40>e?t^i^n:60>e?t&i|t&n|i&n:t^i^n}function sha1_kt(e){return 20>e?1518500249:40>e?1859775393:60>e?-1894007588:-899497514}function safe_add(e,t){var i=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(i>>16);return n<<16|65535&i}function bit_rol(e,t){return e<<t|e>>>32-t}function MGF1(e,t){var i,n,a;for(i=0,a=0;e.length>a;i++){var s=new String;for(n=0;t.length>n;n++)s+=String.fromCharCode(t[n]);s+=String.fromCharCode(255&i>>24),s+=String.fromCharCode(255&i>>16),s+=String.fromCharCode(255&i>>8),s+=String.fromCharCode(255&i);var r=rstr_sha1(s);for(n=0;r.length>n&&e.length>a;n++,a++)e[a]=r.charCodeAt(n)}}function RSA_padding_add_PKCS1_OAEP(e,t,i){var n=new Array(SHA_DIGEST_LENGTH),a=new SecureRandom;a.nextBytes(n);var s,r=e-1-n.length,o=new Array(r),l=r-t.length-1;if(void 0===i&&(i=""),SHA_DIGEST_LENGTH>l)return console.log("Error - data too large for key size."),null;for(s=0;l>s;s++)o[s]=0;var c=rstr_sha1(i);for(s=0;c.length>s;s++)o[s]=c.charCodeAt(s);for(o[l]=1,s=0;t.length>s;s++)o[s+l+1]=t.charCodeAt(s);var u=new Array(r);if(0>MGF1(u,n))return null;for(s=0;u.length>s;s++)o[s]^=u[s];var d=Array(SHA_DIGEST_LENGTH);if(0>MGF1(d,o))return null;for(s=0;d.length>s;s++)n[s]^=d[s];var h=new String;for(h+=String.fromCharCode(0),s=0;n.length>s;s++)h+=String.fromCharCode(n[s]);for(s=0;o.length>s;s++)h+=String.fromCharCode(o[s]);return h}function asn_get_length(e,t){var i=e[t++];if(i>128){if(129!=i)return console.log("Error:  we lazily don't support keys bigger than 255 bytes.  It'd be easy to fix."),null;i=e[t++]}return[t,i]}function find_sequence(e,t){var i;return t=t||0,48!=e[t++]?(console.log("Error:  public key should start with a sequence flag."),null):(i=asn_get_length(e,t),i?i:null)}function create_rsa_from_mb(e,t){var i,n,a,s,r,o=new Uint8Array(e);if(n=find_sequence(o,t),!n)return null;if(t=n[0],n=find_sequence(o,t),!n)return null;if(t=n[0]+n[1],3!=o[t++])return console.log("Error: expecting bit string next."),null;if(i=asn_get_length(o,t),!i)return null;if(t=i[0],0!=o[t]&&48!=o[t+1])return console.log("Error: unexpected values in bit string."),null;if(n=find_sequence(o,t+1),!n)return null;if(t=n[0],2!=o[t++])return console.log("Error: expecting integer n next."),null;if(i=asn_get_length(o,t),!i)return null;for(t=i[0],a=new Array(i[1]),s=0;i[1]>s;s++)a[s]=o[t+s];if(r=new RSAKey,r.n=new BigInteger(a),t+=i[1],2!=o[t++])return console.log("Error: expecting integer e next."),null;if(i=asn_get_length(o,t),!i)return null;for(t=i[0],r.e=o[t++],s=1;i[1]>s;s++)r.e<<=8,r.e|=o[t++];return r}function rsa_encrypt(e,t){var i,n=[],a=RSA_padding_add_PKCS1_OAEP(e.n.bitLength()+7>>3,t);if(!a)return null;var s=new Array(a.length);for(i=0;a.length>i;i++)s[i]=a.charCodeAt(i);var r=new BigInteger(s),o=e.doPublic(r),l=o.toString(16);for(0!=(1&l.length)&&(l="0"+l),i=0;l.length>i;i+=2)n[i/2]=parseInt(l.substring(i,i+2),16);return n}function disconnect(){sc&&sc.stop()}function spice_error(e){$("#spice-status").text(e),$("#spice-status").removeClass("label-success").addClass("label-important"),disconnect()}function spice_success(){$("#spice-status").text($("#spice-status").text().replace("Connecting","Connected")),$("#spice-status").addClass("label-success")}function connectXPI(){0==$("#spice-xpi").size()&&$("#spice-area").append('<embed type="application/x-spice" height=0 width=0 id="spice-xpi">');var e=$("#spice-area");disconnect();var t=document.embeds[0];t.hostIP=e.data("address"),t.SecurePort=e.data("secure_port"),t.Password=e.data("password"),t.TrustStore=decodeURIComponent(e.data("ca_cert")),t.SSLChannels=String("all"),t.fullScreen=!1,t.Title=e.data("title"),t.connect()}/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
var SPICE_MAGIC="REDQ",SPICE_VERSION_MAJOR=2,SPICE_VERSION_MINOR=2,SPICE_CONNECT_TIMEOUT=3e4,SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION=0,SPICE_COMMON_CAP_AUTH_SPICE=1,SPICE_COMMON_CAP_AUTH_SASL=2,SPICE_COMMON_CAP_MINI_HEADER=3,SPICE_TICKET_KEY_PAIR_LENGTH=1024,SPICE_TICKET_PUBKEY_BYTES=SPICE_TICKET_KEY_PAIR_LENGTH/8+34,SPICE_LINK_ERR_OK=0,SPICE_LINK_ERR_ERROR=1,SPICE_LINK_ERR_INVALID_MAGIC=2,SPICE_LINK_ERR_INVALID_DATA=3,SPICE_LINK_ERR_VERSION_MISMATCH=4,SPICE_LINK_ERR_NEED_SECURED=5,SPICE_LINK_ERR_NEED_UNSECURED=6,SPICE_LINK_ERR_PERMISSION_DENIED=7,SPICE_LINK_ERR_BAD_CONNECTION_ID=8,SPICE_LINK_ERR_CHANNEL_NOT_AVAILABLE=9,SPICE_MSG_MIGRATE=1,SPICE_MSG_MIGRATE_DATA=2,SPICE_MSG_SET_ACK=3,SPICE_MSG_PING=4,SPICE_MSG_WAIT_FOR_CHANNELS=5,SPICE_MSG_DISCONNECTING=6,SPICE_MSG_NOTIFY=7,SPICE_MSG_LIST=8,SPICE_MSG_MAIN_MIGRATE_BEGIN=101,SPICE_MSG_MAIN_MIGRATE_CANCEL=102,SPICE_MSG_MAIN_INIT=103,SPICE_MSG_MAIN_CHANNELS_LIST=104,SPICE_MSG_MAIN_MOUSE_MODE=105,SPICE_MSG_MAIN_MULTI_MEDIA_TIME=106,SPICE_MSG_MAIN_AGENT_CONNECTED=107,SPICE_MSG_MAIN_AGENT_DISCONNECTED=108,SPICE_MSG_MAIN_AGENT_DATA=109,SPICE_MSG_MAIN_AGENT_TOKEN=110,SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST=111,SPICE_MSG_MAIN_MIGRATE_END=112,SPICE_MSG_MAIN_NAME=113,SPICE_MSG_MAIN_UUID=114,SPICE_MSG_END_MAIN=115,SPICE_MSGC_ACK_SYNC=1,SPICE_MSGC_ACK=2,SPICE_MSGC_PONG=3,SPICE_MSGC_MIGRATE_FLUSH_MARK=4,SPICE_MSGC_MIGRATE_DATA=5,SPICE_MSGC_DISCONNECTING=6,SPICE_MSGC_MAIN_CLIENT_INFO=101,SPICE_MSGC_MAIN_MIGRATE_CONNECTED=102,SPICE_MSGC_MAIN_MIGRATE_CONNECT_ERROR=103,SPICE_MSGC_MAIN_ATTACH_CHANNELS=104,SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST=105,SPICE_MSGC_MAIN_AGENT_START=106,SPICE_MSGC_MAIN_AGENT_DATA=107,SPICE_MSGC_MAIN_AGENT_TOKEN=108,SPICE_MSGC_MAIN_MIGRATE_END=109,SPICE_MSGC_END_MAIN=110,SPICE_MSG_DISPLAY_MODE=101,SPICE_MSG_DISPLAY_MARK=102,SPICE_MSG_DISPLAY_RESET=103,SPICE_MSG_DISPLAY_COPY_BITS=104,SPICE_MSG_DISPLAY_INVAL_LIST=105,SPICE_MSG_DISPLAY_INVAL_ALL_PIXMAPS=106,SPICE_MSG_DISPLAY_INVAL_PALETTE=107,SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES=108,SPICE_MSG_DISPLAY_STREAM_CREATE=122,SPICE_MSG_DISPLAY_STREAM_DATA=123,SPICE_MSG_DISPLAY_STREAM_CLIP=124,SPICE_MSG_DISPLAY_STREAM_DESTROY=125,SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL=126,SPICE_MSG_DISPLAY_DRAW_FILL=302,SPICE_MSG_DISPLAY_DRAW_OPAQUE=303,SPICE_MSG_DISPLAY_DRAW_COPY=304,SPICE_MSG_DISPLAY_DRAW_BLEND=305,SPICE_MSG_DISPLAY_DRAW_BLACKNESS=306,SPICE_MSG_DISPLAY_DRAW_WHITENESS=307,SPICE_MSG_DISPLAY_DRAW_INVERS=308,SPICE_MSG_DISPLAY_DRAW_ROP3=309,SPICE_MSG_DISPLAY_DRAW_STROKE=310,SPICE_MSG_DISPLAY_DRAW_TEXT=311,SPICE_MSG_DISPLAY_DRAW_TRANSPARENT=312,SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND=313,SPICE_MSG_DISPLAY_SURFACE_CREATE=314,SPICE_MSG_DISPLAY_SURFACE_DESTROY=315,SPICE_MSGC_DISPLAY_INIT=101,SPICE_MSG_INPUTS_INIT=101,SPICE_MSG_INPUTS_KEY_MODIFIERS=102,SPICE_MSG_INPUTS_MOUSE_MOTION_ACK=111,SPICE_MSGC_INPUTS_KEY_DOWN=101,SPICE_MSGC_INPUTS_KEY_UP=102,SPICE_MSGC_INPUTS_KEY_MODIFIERS=103,SPICE_MSGC_INPUTS_MOUSE_MOTION=111,SPICE_MSGC_INPUTS_MOUSE_POSITION=112,SPICE_MSGC_INPUTS_MOUSE_PRESS=113,SPICE_MSGC_INPUTS_MOUSE_RELEASE=114,SPICE_MSG_CURSOR_INIT=101,SPICE_MSG_CURSOR_RESET=102,SPICE_MSG_CURSOR_SET=103,SPICE_MSG_CURSOR_MOVE=104,SPICE_MSG_CURSOR_HIDE=105,SPICE_MSG_CURSOR_TRAIL=106,SPICE_MSG_CURSOR_INVAL_ONE=107,SPICE_MSG_CURSOR_INVAL_ALL=108,SPICE_CHANNEL_MAIN=1,SPICE_CHANNEL_DISPLAY=2,SPICE_CHANNEL_INPUTS=3,SPICE_CHANNEL_CURSOR=4,SPICE_CHANNEL_PLAYBACK=5,SPICE_CHANNEL_RECORD=6,SPICE_CHANNEL_TUNNEL=7,SPICE_CHANNEL_SMARTCARD=8,SPICE_CHANNEL_USBREDIR=9,SPICE_SURFACE_FLAGS_PRIMARY=1,SPICE_NOTIFY_SEVERITY_INFO=0,SPICE_NOTIFY_SEVERITY_WARN=1,SPICE_NOTIFY_SEVERITY_ERROR=2,SPICE_MOUSE_MODE_SERVER=1,SPICE_MOUSE_MODE_CLIENT=2,SPICE_MOUSE_MODE_MASK=3,SPICE_CLIP_TYPE_NONE=0,SPICE_CLIP_TYPE_RECTS=1,SPICE_IMAGE_TYPE_BITMAP=0,SPICE_IMAGE_TYPE_QUIC=1,SPICE_IMAGE_TYPE_RESERVED=2,SPICE_IMAGE_TYPE_LZ_PLT=100,SPICE_IMAGE_TYPE_LZ_RGB=101,SPICE_IMAGE_TYPE_GLZ_RGB=102,SPICE_IMAGE_TYPE_FROM_CACHE=103,SPICE_IMAGE_TYPE_SURFACE=104,SPICE_IMAGE_TYPE_JPEG=105,SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS=106,SPICE_IMAGE_TYPE_ZLIB_GLZ_RGB=107,SPICE_IMAGE_TYPE_JPEG_ALPHA=108,SPICE_IMAGE_FLAGS_CACHE_ME=1,SPICE_IMAGE_FLAGS_HIGH_BITS_SET=2,SPICE_IMAGE_FLAGS_CACHE_REPLACE_ME=4,SPICE_BITMAP_FLAGS_PAL_CACHE_ME=1,SPICE_BITMAP_FLAGS_PAL_FROM_CACHE=2,SPICE_BITMAP_FLAGS_TOP_DOWN=4,SPICE_BITMAP_FLAGS_MASK=7,SPICE_BITMAP_FMT_INVALID=0,SPICE_BITMAP_FMT_1BIT_LE=1,SPICE_BITMAP_FMT_1BIT_BE=2,SPICE_BITMAP_FMT_4BIT_LE=3,SPICE_BITMAP_FMT_4BIT_BE=4,SPICE_BITMAP_FMT_8BIT=5,SPICE_BITMAP_FMT_16BIT=6,SPICE_BITMAP_FMT_24BIT=7,SPICE_BITMAP_FMT_32BIT=8,SPICE_BITMAP_FMT_RGBA=9,SPICE_CURSOR_FLAGS_NONE=1,SPICE_CURSOR_FLAGS_CACHE_ME=2,SPICE_CURSOR_FLAGS_FROM_CACHE=4,SPICE_CURSOR_FLAGS_MASK=7,SPICE_MOUSE_BUTTON_MASK_LEFT=1,SPICE_MOUSE_BUTTON_MASK_MIDDLE=2,SPICE_MOUSE_BUTTON_MASK_RIGHT=4,SPICE_MOUSE_BUTTON_MASK_MASK=7,SPICE_MOUSE_BUTTON_INVALID=0,SPICE_MOUSE_BUTTON_LEFT=1,SPICE_MOUSE_BUTTON_MIDDLE=2,SPICE_MOUSE_BUTTON_RIGHT=3,SPICE_MOUSE_BUTTON_UP=4,SPICE_MOUSE_BUTTON_DOWN=5,SPICE_BRUSH_TYPE_NONE=0,SPICE_BRUSH_TYPE_SOLID=1,SPICE_BRUSH_TYPE_PATTERN=2,SPICE_SURFACE_FMT_INVALID=0,SPICE_SURFACE_FMT_1_A=1,SPICE_SURFACE_FMT_8_A=8,SPICE_SURFACE_FMT_16_555=16,SPICE_SURFACE_FMT_32_xRGB=32,SPICE_SURFACE_FMT_16_565=80,SPICE_SURFACE_FMT_32_ARGB=96,SPICE_ROPD_INVERS_SRC=1,SPICE_ROPD_INVERS_BRUSH=2,SPICE_ROPD_INVERS_DEST=4,SPICE_ROPD_OP_PUT=8,SPICE_ROPD_OP_OR=16,SPICE_ROPD_OP_AND=32,SPICE_ROPD_OP_XOR=64,SPICE_ROPD_OP_BLACKNESS=128,SPICE_ROPD_OP_WHITENESS=256,SPICE_ROPD_OP_INVERS=512,SPICE_ROPD_INVERS_RES=1024,SPICE_ROPD_MASK=2047,LZ_IMAGE_TYPE_INVALID=0,LZ_IMAGE_TYPE_PLT1_LE=1,LZ_IMAGE_TYPE_PLT1_BE=2,LZ_IMAGE_TYPE_PLT4_LE=3,LZ_IMAGE_TYPE_PLT4_BE=4,LZ_IMAGE_TYPE_PLT8=5,LZ_IMAGE_TYPE_RGB16=6,LZ_IMAGE_TYPE_RGB24=7,LZ_IMAGE_TYPE_RGB32=8,LZ_IMAGE_TYPE_RGBA=9,LZ_IMAGE_TYPE_XXXA=10,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,SPICE_INPUT_MOTION_ACK_BUNCH=4,SPICE_CURSOR_TYPE_ALPHA=0,SPICE_CURSOR_TYPE_MONO=1,SPICE_CURSOR_TYPE_COLOR4=2,SPICE_CURSOR_TYPE_COLOR8=3,SPICE_CURSOR_TYPE_COLOR16=4,SPICE_CURSOR_TYPE_COLOR24=5,SPICE_CURSOR_TYPE_COLOR32=6,SPICE_VIDEO_CODEC_TYPE_MJPEG=1,KEY_Escape=1,KEY_1=2,KEY_2=3,KEY_3=4,KEY_4=5,KEY_5=6,KEY_6=7,KEY_7=8,KEY_8=9,KEY_9=10,KEY_0=11,KEY_Minus=12,KEY_Equal=13,KEY_BackSpace=14,KEY_Tab=15,KEY_Q=16,KEY_W=17,KEY_E=18,KEY_R=19,KEY_T=20,KEY_Y=21,KEY_U=22,KEY_I=23,KEY_O=24,KEY_P=25,KEY_LBrace=26,KEY_RBrace=27,KEY_Enter=28,KEY_LCtrl=29,KEY_A=30,KEY_S=31,KEY_D=32,KEY_F=33,KEY_G=34,KEY_H=35,KEY_J=36,KEY_K=37,KEY_L=38,KEY_SemiColon=39,KEY_Quote=40,KEY_Tilde=41,KEY_ShiftL=42,KEY_BSlash=43,KEY_Z=44,KEY_X=45,KEY_C=46,KEY_V=47,KEY_B=48,KEY_N=49,KEY_M=50,KEY_Comma=51,KEY_Period=52,KEY_Slash=53,KEY_ShiftR=54,KEY_KP_Multiply=55,KEY_Alt=56,KEY_Space=57,KEY_CapsLock=58,KEY_F1=59,KEY_F2=60,KEY_F3=61,KEY_F4=62,KEY_F5=63,KEY_F6=64,KEY_F7=65,KEY_F8=66,KEY_F9=67,KEY_F10=68,KEY_NumLock=69,KEY_ScrollLock=70,KEY_KP_7=71,KEY_KP_8=72,KEY_KP_9=73,KEY_KP_Minus=74,KEY_KP_4=75,KEY_KP_5=76,KEY_KP_6=77,KEY_KP_Plus=78,KEY_KP_1=79,KEY_KP_2=80,KEY_KP_3=81,KEY_KP_0=82,KEY_KP_Decimal=83,KEY_SysReqest=84,KEY_Less=86,KEY_F11=87,KEY_F12=88,KEY_Prefix0=96,KEY_Prefix1=97,DEBUG=0,DUMP_DRAWS=!1,DUMP_CANVASES=!1,common_scanmap=[];common_scanmap["Q".charCodeAt(0)]=KEY_Q,common_scanmap["W".charCodeAt(0)]=KEY_W,common_scanmap["E".charCodeAt(0)]=KEY_E,common_scanmap["R".charCodeAt(0)]=KEY_R,common_scanmap["T".charCodeAt(0)]=KEY_T,common_scanmap["Y".charCodeAt(0)]=KEY_Y,common_scanmap["U".charCodeAt(0)]=KEY_U,common_scanmap["I".charCodeAt(0)]=KEY_I,common_scanmap["O".charCodeAt(0)]=KEY_O,common_scanmap["P".charCodeAt(0)]=KEY_P,common_scanmap["A".charCodeAt(0)]=KEY_A,common_scanmap["S".charCodeAt(0)]=KEY_S,common_scanmap["D".charCodeAt(0)]=KEY_D,common_scanmap["F".charCodeAt(0)]=KEY_F,common_scanmap["G".charCodeAt(0)]=KEY_G,common_scanmap["H".charCodeAt(0)]=KEY_H,common_scanmap["J".charCodeAt(0)]=KEY_J,common_scanmap["K".charCodeAt(0)]=KEY_K,common_scanmap["L".charCodeAt(0)]=KEY_L,common_scanmap["Z".charCodeAt(0)]=KEY_Z,common_scanmap["X".charCodeAt(0)]=KEY_X,common_scanmap["C".charCodeAt(0)]=KEY_C,common_scanmap["V".charCodeAt(0)]=KEY_V,common_scanmap["B".charCodeAt(0)]=KEY_B,common_scanmap["N".charCodeAt(0)]=KEY_N,common_scanmap["M".charCodeAt(0)]=KEY_M,common_scanmap[" ".charCodeAt(0)]=KEY_Space,common_scanmap[13]=KEY_Enter,common_scanmap[27]=KEY_Escape,common_scanmap[8]=KEY_BackSpace,common_scanmap[9]=KEY_Tab,common_scanmap[16]=KEY_ShiftL,common_scanmap[17]=KEY_LCtrl,common_scanmap[18]=KEY_Alt,common_scanmap[20]=KEY_CapsLock,common_scanmap[144]=KEY_NumLock,common_scanmap[112]=KEY_F1,common_scanmap[113]=KEY_F2,common_scanmap[114]=KEY_F3,common_scanmap[115]=KEY_F4,common_scanmap[116]=KEY_F5,common_scanmap[117]=KEY_F6,common_scanmap[118]=KEY_F7,common_scanmap[119]=KEY_F8,common_scanmap[120]=KEY_F9,common_scanmap[121]=KEY_F10,common_scanmap[122]=KEY_F11,common_scanmap[123]=KEY_F12,common_scanmap[42]=99,common_scanmap[19]=101,common_scanmap[111]=57397,common_scanmap[106]=57399,common_scanmap[36]=57415,common_scanmap[38]=57416,common_scanmap[33]=57417,common_scanmap[37]=57419,common_scanmap[39]=57421,common_scanmap[35]=57423,common_scanmap[40]=57424,common_scanmap[34]=57425,common_scanmap[45]=57426,common_scanmap[46]=57427,common_scanmap[44]=10807,common_scanmap["1".charCodeAt(0)]=KEY_1,common_scanmap["2".charCodeAt(0)]=KEY_2,common_scanmap["3".charCodeAt(0)]=KEY_3,common_scanmap["4".charCodeAt(0)]=KEY_4,common_scanmap["5".charCodeAt(0)]=KEY_5,common_scanmap["6".charCodeAt(0)]=KEY_6,common_scanmap["7".charCodeAt(0)]=KEY_7,common_scanmap["8".charCodeAt(0)]=KEY_8,common_scanmap["9".charCodeAt(0)]=KEY_9,common_scanmap["0".charCodeAt(0)]=KEY_0,common_scanmap[145]=KEY_ScrollLock,common_scanmap[103]=KEY_KP_7,common_scanmap[104]=KEY_KP_8,common_scanmap[105]=KEY_KP_9,common_scanmap[100]=KEY_KP_4,common_scanmap[101]=KEY_KP_5,common_scanmap[102]=KEY_KP_6,common_scanmap[107]=KEY_KP_Plus,common_scanmap[97]=KEY_KP_1,common_scanmap[98]=KEY_KP_2,common_scanmap[99]=KEY_KP_3,common_scanmap[96]=KEY_KP_0,common_scanmap[110]=KEY_KP_Decimal,common_scanmap[191]=KEY_Slash,common_scanmap[190]=KEY_Period,common_scanmap[188]=KEY_Comma,common_scanmap[220]=KEY_BSlash,common_scanmap[192]=KEY_Tilde,common_scanmap[222]=KEY_Quote,common_scanmap[219]=KEY_LBrace,common_scanmap[221]=KEY_RBrace,common_scanmap[91]=57435,common_scanmap[92]=57436,common_scanmap[93]=57437;var firefox_scanmap=[];firefox_scanmap[109]=KEY_Minus,firefox_scanmap[61]=KEY_Equal,firefox_scanmap[59]=KEY_SemiColon;var DOM_scanmap=[];DOM_scanmap[189]=KEY_Minus,DOM_scanmap[187]=KEY_Equal,DOM_scanmap[186]=KEY_SemiColon;/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
var rfc2083_crc_table=Array(256),rfc2083_crc_table_computed=0;PngIHDR.prototype={to_buffer:function(e,t){t=t||0;var i=t,n=new SpiceDataView(e);return n.setUint32(t,this.buffer_size()-12),t+=4,n.setUint8(t,"I".charCodeAt(0)),t++,n.setUint8(t,"H".charCodeAt(0)),t++,n.setUint8(t,"D".charCodeAt(0)),t++,n.setUint8(t,"R".charCodeAt(0)),t++,n.setUint32(t,this.width),t+=4,n.setUint32(t,this.height),t+=4,n.setUint8(t,this.depth),t++,n.setUint8(t,this.type),t++,n.setUint8(t,this.compression),t++,n.setUint8(t,this.filter),t++,n.setUint8(t,this.interlace),t++,n.setUint32(t,crc32(e,i+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 25}},adler.prototype.update=function(e){this.s1+=e,this.s1%=65521,this.s2+=this.s1,this.s2%=65521},PngIDAT.prototype={to_buffer:function(e,t){t=t||0;var i,n,a,s=t,r=new SpiceDataView(e),o=new adler;r.setUint32(t,this.buffer_size()-12),t+=4,r.setUint8(t,"I".charCodeAt(0)),t++,r.setUint8(t,"D".charCodeAt(0)),t++,r.setUint8(t,"A".charCodeAt(0)),t++,r.setUint8(t,"T".charCodeAt(0)),t++,r.setUint8(t,120),t++,r.setUint8(t,1),t++,r.setUint8(t,128),t++,r.setUint16(t,this.data.byteLength+this.height),t+=2,r.setUint16(t,~(this.data.byteLength+this.height)),t+=2;var l=new Uint8Array(this.data);for(a=0,n=0;this.height>n;n++)for(r.setUint8(t,0),t++,o.update(0),i=0;this.width>i&&this.data.byteLength>a;i++)o.update(l[a]),r.setUint8(t,l[a++]),t++,o.update(l[a]),r.setUint8(t,l[a++]),t++,o.update(l[a]),r.setUint8(t,l[a++]),t++,o.update(l[a]),r.setUint8(t,l[a++]),t++;return r.setUint16(t,o.s2),t+=2,r.setUint16(t,o.s1),t+=2,r.setUint32(t,crc32(e,s+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 12+this.data.byteLength+this.height+4+2+1+2+2}},PngIEND.prototype={to_buffer:function(e,t){t=t||0;var i=t,n=new SpiceDataView(e);return n.setUint32(t,this.buffer_size()-12),t+=4,n.setUint8(t,"I".charCodeAt(0)),t++,n.setUint8(t,"E".charCodeAt(0)),t++,n.setUint8(t,"N".charCodeAt(0)),t++,n.setUint8(t,"D".charCodeAt(0)),t++,n.setUint32(t,crc32(e,i+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 12}};/*
 *    Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>
 *    Copyright (C) 2012 by Aric Stewart <aric@codeweavers.com>
 *
 *    This file is part of spice-html5.
 *
 *    spice-html5 is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU Lesser General Public License as published by
 *    the Free Software Foundation, either version 3 of the License, or
 *    (at your option) any later version.
 *
 *    spice-html5 is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU Lesser General Public License for more details.
 *
 *    You should have received a copy of the GNU Lesser General Public License
 *    along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
 */
var encoder,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,DEFevol=3,DEFwmimax=6,DEFwminext=2048,need_init=!0,DEFmaxclen=26,evol=DEFevol,wmimax=DEFwmimax,wminext=DEFwminext,family_5bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},family_8bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},bppmask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431,67108863,134217727,268435455,536870911,1073741823,2147483647,4294967295],zeroLUT=[],besttrigtab=[[550,900,800,700,500,350,300,200,180,180,160],[110,550,900,800,550,400,350,250,140,160,140],[100,120,550,900,700,500,400,300,220,250,160]],J=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,5,5,6,6,7,7,8,9,10,11,12,13,14,15],lzeroes=[8,7,6,6,5,5,5,5,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],tabrand_chaos=[46495042,893548311,794435923,2453991765,2077388039,894197842,1462934312,697534094,1826128012,343623392,2581292719,3811265708,459739748,2638427270,1654964626,101227083,2654850628,3668700691,572794346,2758751005,3445133904,2344099199,3367450297,898927923,3618406352,1606297603,754696453,20823118,2050458127,972590750,3990194068,3305596553,4239238564,1690498157,3015324227,2306127097,1510321853,548392192,971157512,2292288069,1611390505,4086766286,4084927083,1883326811,1891043243,113180603,1107690783,3778825955,3248980775,2443839100,2190866218,1932072870,495393613,1078522166,4051963518,1784694977,1768732442,2146763203,264646923,1474361405,2361552500,296035746,2489922759,2094565616,2409465348,1334241083,72483606,3740181004,4057920662,1734898312,4114662834,574624900,880305546,3258472262,26713132,1571648456,52557195,4043234286,2458021343,676064371,1528437109,64953873,546717185,2709319979,1947039598,2812723004,28691684,286829174,4235176970,3465707163,12526951,2154766700,3165032534,2036061161,3386656087,2301212354,2023576300,1061142336,3105452904,2743866805,3283373992,3397596080,3085489552,3196092395,3210707808,3651022684,925444321,2088074316,230011220,3223248386,533229176,523863486,3028311159,13140218,2538347282,900399636,3000796173,1526771255,3541282854,2992674461,2135722105,389334227,1225164337,3119947809,1803959919,3471171263,704170491,1407019136,1924534819,526887421,168782227,333811993,298623278,4268451686,381087740,2542899140,3266880867,2498950977,200969370,3511909096,3252303004,2268881098,2499828613,2606499854,3163208665,3790254546,1840025712,1319758833,3771674836,519421307,3512796222,1563402978,4284300462,2263719815,715250337,3178437172,2660191010,2982332026,3256309961,2709659997,3434092872,2367065591,69438718,915160508,183164069,3134331940,175242981,2680543346,1421955782,4231173251,1736652874,3990568476,1710820912,2286604440,3464587098,1261907837,1757387321,1128554270,1090050251,2429922486,1288729218,882830086,211637042,1376462063,2147615815,1737974929,798170275,4271572277,4241687072,1638524620,2760366295,1065115089,2097227717,1224023317,1625204849,3383303351,1488272307,2640186157,1649047732,819719707,2615091943,502645401,760628135,4108137983,63606742,1404337880,1865161130,4272996852,1239761976,790984678,3213322601,1917062825,4195069880,1962259360,2111002573,2311983960,1861406170,511141875,2797510619,1331661048,3130608186,147483493,3767089176,2650841450,4096523407,2574446300,1956416337,851468126,3607527519,1811658703,3642821136,832691095,2453312857,933732854,94341217,3393797730,1695907457,2405722077,2877685663,2469507058,2249636341,3988608661,4001245617,825934927,3103985967,1127151177,3691656896,1640967098,2168932645,2830550957,3998822878,3002602893,1509651465,775813869,2599574079,3791574229],rgb32_pixel_pad=3,rgb32_pixel_r=2,rgb32_pixel_g=1,rgb32_pixel_b=0,rgb32_pixel_size=4;if(QuicModel.prototype={n_buckets:0,n_buckets_ptrs:0,repfirst:0,firstsize:0,repnext:0,mulsize:0,levels:0},QuicBucket.prototype={bestcode:0,reste:function(e){this.bestcode=e,this.counters=[0,0,0,0,0,0,0,0]},update_model_8bpc:function(e,t,i){var n,a=i-1,s=this.counters[a]+=golomb_code_len_8bpc(t,a);for(n=i-2;n>=0;n--){var r=this.counters[n]+=golomb_code_len_8bpc(t,n);s>r&&(a=n,s=r)}if(this.bestcode=a,s>e.wm_trigger)for(n=0;i>n;n++)this.counters[n]=this.counters[n]>>>1}},QuicFamilyStat.prototype={fill_model_structures:function(e){var t,i=0,n=0,a=e.repfirst+1,s=e.firstsize;do{t=n?i+1:0,--a||(a=e.repnext,s*=e.mulsize),i=t+s-1,i+s>=e.levels&&(i=e.levels-1),this.buckets_buf[n]=new QuicBucket;var r;for(r=t;i>=r;r++)this.buckets_ptrs[r]=this.buckets_buf[n];n++}while(e.levels-1>i);return!0}},QuicChannel.prototype={reste:function(e){var t;if(this.correlate_row={zero:0,row:[]},8==e){for(t=0;this.model_8bpc.n_buckets>t;t++)this.family_stat_8bpc.buckets_buf[t].reste(7);this.buckets_ptrs=this.family_stat_8bpc.buckets_ptrs}else{if(5!=e)return console.log("quic: %s: bad bpc %d\n",__FUNCTION__,e),!1;for(t=0;this.model_5bpc.n_buckets>t;t++)this.family_stat_8bpc.buckets_buf[t].reste(4);this.buckets_ptrs=this.family_stat_5bpc.buckets_ptrs}return this.state.reste(),!0}},CommonState.prototype={waitcnt:0,tabrand_seed:255,wm_trigger:0,wmidx:0,wmileft:wminext,melcstate:0,melclen:0,melcorder:0,set_wm_trigger:function(){var e=this.wmidx;e>10&&(e=10),this.wm_trigger=besttrigtab[Math.floor(evol/2)][e]},reste:function(){this.waitcnt=0,this.tabrand_seed=255,this.wmidx=0,this.wmileft=wminext,this.set_wm_trigger(),this.melcstate=0,this.melclen=J[0],this.melcorder=1<<this.melclen},tabrand:function(){return this.tabrand_seed++,tabrand_chaos[255&this.tabrand_seed]}},QuicEncoder.prototype={type:0,width:0,height:0,io_idx:0,io_available_bits:0,io_word:0,io_next_word:0,io_now:0,io_end:0,rows_completed:0},QuicEncoder.prototype.reste=function(e){return this.rgb_state.reste(),this.io_now=e,this.io_end=this.io_now.length,this.io_idx=0,this.rows_completed=0,!0},QuicEncoder.prototype.read_io_word=function(){if(this.io_idx>=this.io_end)throw"quic: out of data";this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24},QuicEncoder.prototype.decode_eatbits=function(e){this.io_word=this.io_word<<e;var t=this.io_available_bits-e;t>=0?(this.io_available_bits=t,this.io_word|=this.io_next_word>>>this.io_available_bits):(t=-1*t,this.io_word|=this.io_next_word<<t,this.read_io_word(),this.io_available_bits=32-t,this.io_word|=this.io_next_word>>>this.io_available_bits)},QuicEncoder.prototype.decode_eat32bits=function(){this.decode_eatbits(16),this.decode_eatbits(16)},QuicEncoder.prototype.reste_channels=function(e){var t;for(t=0;4>t;t++)if(!this.channels[t].reste(e))return!1;return!0},QuicEncoder.prototype.quic_decode_begin=function(e){if(!this.reste(e))return!1;this.io_idx=0,this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24,this.io_word=this.io_next_word,this.io_available_bits=0;var t=this.io_word;if(this.decode_eat32bits(),1128879441!=t)return console.log("quic: bad magic "+t.toString(16)),!1;var i=this.io_word;if(this.decode_eat32bits(),0!=i)return console.log("quic: bad version "+i.toString(16)),!1;this.type=this.io_word,this.decode_eat32bits(),this.width=this.io_word,this.decode_eat32bits(),this.height=this.io_word,this.decode_eat32bits();var n=quic_image_bpc(this.type);return this.reste_channels(n)?!0:!1},QuicEncoder.prototype.quic_rgb32_uncompress_row0_seg=function(e,t,i,n,a,s){var r,o,l,c=3;if(e)r=e+this.rgb_state.waitcnt;else{t[rgb32_pixel_pad]=0,o=0;do l=golomb_decoding_8bpc(this.channels[o].buckets_ptrs[this.channels[o].correlate_row.zero].bestcode,this.io_word),this.channels[o].correlate_row.row[0]=l.rc,t[2-o]=255&family_8bpc.xlatL2U[l.rc],this.decode_eatbits(l.codewordlen);while(c>++o);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&n,o=0;do this.channels[o].buckets_ptrs[this.channels[o].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[o].correlate_row.row[0],a);while(c>++o)}r=++e+this.rgb_state.waitcnt}for(;i>r;){for(;r>=e;e++){t[e*rgb32_pixel_size+rgb32_pixel_pad]=0,o=0;do l=golomb_decoding_8bpc(this.channels[o].buckets_ptrs[this.channels[o].correlate_row.row[e-1]].bestcode,this.io_word),this.channels[o].correlate_row.row[e]=l.rc,t[e*rgb32_pixel_size+(2-o)]=family_8bpc.xlatL2U[l.rc]+t[(e-1)*rgb32_pixel_size+(2-o)]&s,this.decode_eatbits(l.codewordlen);while(c>++o)}o=0;do this.channels[o].buckets_ptrs[this.channels[o].correlate_row.row[r-1]].update_model_8bpc(this.rgb_state,this.channels[o].correlate_row.row[r],a);while(c>++o);r=e+(this.rgb_state.tabrand()&n)}for(;i>e;e++){t[e*rgb32_pixel_size+rgb32_pixel_pad]=0,o=0;do l=golomb_decoding_8bpc(this.channels[o].buckets_ptrs[this.channels[o].correlate_row.row[e-1]].bestcode,this.io_word),this.channels[o].correlate_row.row[e]=l.rc,t[e*rgb32_pixel_size+(2-o)]=family_8bpc.xlatL2U[l.rc]+t[(e-1)*rgb32_pixel_size+(2-o)]&s,this.decode_eatbits(l.codewordlen);while(c>++o)}this.rgb_state.waitcnt=r-i},QuicEncoder.prototype.quic_rgb32_uncompress_row0=function(e){for(var t=8,i=255,n=0,a=this.width;wmimax>this.rgb_state.wmidx&&a>=this.rgb_state.wmileft;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row0_seg(n,e,n+this.rgb_state.wmileft,bppmask[this.rgb_state.wmidx],t,i),n+=this.rgb_state.wmileft,a-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;a&&(this.quic_rgb32_uncompress_row0_seg(n,e,n+a,bppmask[this.rgb_state.wmidx],t,i),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=a))},QuicEncoder.prototype.quic_rgb32_uncompress_row_seg=function(e,t,i,n,a,s){var r,o,l=3,c=bppmask[this.rgb_state.wmidx],u=0,d=0,h=0;if(i)d=i+this.rgb_state.waitcnt;else{t[rgb32_pixel_pad]=0,o=0;do r=golomb_decoding_8bpc(this.channels[o].buckets_ptrs[this.channels[o].correlate_row.zero].bestcode,this.io_word),this.channels[o].correlate_row.row[0]=r.rc,t[2-o]=family_8bpc.xlatL2U[this.channels[o].correlate_row.row[0]]+e[2-o]&s,this.decode_eatbits(r.codewordlen);while(l>++o);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&c,o=0;do this.channels[o].buckets_ptrs[this.channels[o].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[o].correlate_row.row[0],a);while(l>++o)}d=++i+this.rgb_state.waitcnt}for(;;){for(var p=0;n>d&&!p;){for(;d>=i&&!p;i++){var f=i*rgb32_pixel_size,m=(i-1)*rgb32_pixel_size,_=(i-2)*rgb32_pixel_size;if(e[m+rgb32_pixel_r]==e[f+rgb32_pixel_r]&&e[m+rgb32_pixel_g]==e[f+rgb32_pixel_g]&&e[m+rgb32_pixel_b]==e[f+rgb32_pixel_b]&&u!=i&&i>2&&t[m+rgb32_pixel_r]==t[_+rgb32_pixel_r]&&t[m+rgb32_pixel_g]==t[_+rgb32_pixel_g]&&t[m+rgb32_pixel_b]==t[_+rgb32_pixel_b]){for(this.rgb_state.waitcnt=d-i,u=i,h=i+this.decode_run(this.rgb_state);h>i;i++){var f=i*rgb32_pixel_size,m=(i-1)*rgb32_pixel_size;t[f+rgb32_pixel_pad]=0,t[f+rgb32_pixel_r]=t[m+rgb32_pixel_r],t[f+rgb32_pixel_g]=t[m+rgb32_pixel_g],t[f+rgb32_pixel_b]=t[m+rgb32_pixel_b]}if(i==n)return;d=i+this.rgb_state.waitcnt,p=1;break}o=0,t[f+rgb32_pixel_pad]=0;do{var g=this.channels[o],b=g.correlate_row;r=golomb_decoding_8bpc(g.buckets_ptrs[b.row[i-1]].bestcode,this.io_word),b.row[i]=r.rc,t[f+(2-o)]=family_8bpc.xlatL2U[r.rc]+(t[m+(2-o)]+e[f+(2-o)]>>1)&s,this.decode_eatbits(r.codewordlen)}while(l>++o)}if(p)break;o=0;do this.channels[o].buckets_ptrs[this.channels[o].correlate_row.row[d-1]].update_model_8bpc(this.rgb_state,this.channels[o].correlate_row.row[d],a);while(l>++o);d=i+(this.rgb_state.tabrand()&c)}for(;n>i&&!p;i++){var f=i*rgb32_pixel_size,m=(i-1)*rgb32_pixel_size,_=(i-2)*rgb32_pixel_size;if(e[m+rgb32_pixel_r]==e[f+rgb32_pixel_r]&&e[m+rgb32_pixel_g]==e[f+rgb32_pixel_g]&&e[m+rgb32_pixel_b]==e[f+rgb32_pixel_b]&&u!=i&&i>2&&t[m+rgb32_pixel_r]==t[_+rgb32_pixel_r]&&t[m+rgb32_pixel_g]==t[_+rgb32_pixel_g]&&t[m+rgb32_pixel_b]==t[_+rgb32_pixel_b]){for(this.rgb_state.waitcnt=d-i,u=i,h=i+this.decode_run(this.rgb_state);h>i;i++){var f=i*rgb32_pixel_size,m=(i-1)*rgb32_pixel_size;t[f+rgb32_pixel_pad]=0,t[f+rgb32_pixel_r]=t[m+rgb32_pixel_r],t[f+rgb32_pixel_g]=t[m+rgb32_pixel_g],t[f+rgb32_pixel_b]=t[m+rgb32_pixel_b]}if(i==n)return;d=i+this.rgb_state.waitcnt,p=1;break}t[f+rgb32_pixel_pad]=0,o=0;do r=golomb_decoding_8bpc(this.channels[o].buckets_ptrs[this.channels[o].correlate_row.row[i-1]].bestcode,this.io_word),this.channels[o].correlate_row.row[i]=r.rc,t[f+(2-o)]=family_8bpc.xlatL2U[r.rc]+(t[m+(2-o)]+e[f+(2-o)]>>1)&s,this.decode_eatbits(r.codewordlen);while(l>++o)}if(!p)return this.rgb_state.waitcnt=d-n,void 0}},QuicEncoder.prototype.decode_run=function(e){for(var t=0;;){var i,n=255&~(this.io_word>>>24)>>>0,a=zeroLUT[n];for(i=1;a>=i;i++)t+=e.melcorder,32>e.melcstate&&(e.melclen=J[++e.melcstate],e.melcorder=1<<e.melclen);if(8!=a){this.decode_eatbits(a+1);break}this.decode_eatbits(8)}return e.melclen&&(t+=this.io_word>>>32-e.melclen,this.decode_eatbits(e.melclen)),e.melcstate&&(e.melclen=J[--e.melcstate],e.melcorder=1<<e.melclen),t},QuicEncoder.prototype.quic_rgb32_uncompress_row=function(e,t){for(var i=8,n=255,a=0,s=this.width;wmimax>this.rgb_state.wmidx&&s>=this.rgb_state.wmileft;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row_seg(e,t,a,a+this.rgb_state.wmileft,i,n),a+=this.rgb_state.wmileft,s-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;s&&(this.quic_rgb32_uncompress_row_seg(e,t,a,a+s,i,n),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=s))},QuicEncoder.prototype.quic_four_uncompress_row0_seg=function(e,t,i,n,a,s,r,o){var l,c;for(0==t?(c=golomb_decoding_8bpc(e.buckets_ptrs[i.zero].bestcode,this.io_word),i.row[0]=c.rc,n[rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc],this.decode_eatbits(c.codewordlen),e.state.waitcnt?--e.state.waitcnt:(e.state.waitcnt=e.state.tabrand()&s,e.buckets_ptrs[i.zero].update_model_8bpc(e.state,i.row[0],r)),l=++t+e.state.waitcnt):l=t+e.state.waitcnt;a>l;){for(var u;l>=t;t++)u=e.buckets_ptrs[i.row[t-1]],c=golomb_decoding_8bpc(u.bestcode,this.io_word),i.row[t]=c.rc,n[t*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+n[(t-1)*rgb32_pixel_size+rgb32_pixel_pad]&o,this.decode_eatbits(c.codewordlen);u.update_model_8bpc(e.state,i.row[l],r),l=t+(e.state.tabrand()&s)}for(;a>t;t++)c=golomb_decoding_8bpc(e.buckets_ptrs[i.row[t-1]].bestcode,this.io_word),i.row[t]=c.rc,n[t*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+n[(t-1)*rgb32_pixel_size+rgb32_pixel_pad]&o,this.decode_eatbits(c.codewordlen);e.state.waitcnt=l-a},QuicEncoder.prototype.quic_four_uncompress_row0=function(e,t){for(var i=8,n=255,a=e.correlate_row,s=0,r=this.width;wmimax>e.state.wmidx&&r>=e.state.wmileft;)e.state.wmileft&&(this.quic_four_uncompress_row0_seg(e,s,a,t,s+e.state.wmileft,bppmask[e.state.wmidx],i,n),s+=e.state.wmileft,r-=e.state.wmileft),e.state.wmidx++,e.state.set_wm_trigger(),e.state.wmileft=wminext;r&&(this.quic_four_uncompress_row0_seg(e,s,a,t,s+r,bppmask[e.state.wmidx],i,n),wmimax>e.state.wmidx&&(e.state.wmileft-=r))},QuicEncoder.prototype.quic_four_uncompress_row_seg=function(e,t,i,n,a,s,r,o){var l,c,u,d=bppmask[e.state.wmidx],h=0;for(0==a?(u=golomb_decoding_8bpc(e.buckets_ptrs[t.zero].bestcode,this.io_word),t.row[0]=u.rc,n[rgb32_pixel_pad]=family_8bpc.xlatL2U[u.rc]+i[rgb32_pixel_pad]&o,this.decode_eatbits(u.codewordlen),e.state.waitcnt?--e.state.waitcnt:(e.state.waitcnt=e.state.tabrand()&d,e.buckets_ptrs[t.zero].update_model_8bpc(e.state,t.row[0],r)),l=++a+e.state.waitcnt):l=a+e.state.waitcnt;;){for(var p=0;s>l&&!p;){for(var f;l>=a&&!p;a++){var m=a*rgb32_pixel_size,_=(a-1)*rgb32_pixel_size,g=(a-2)*rgb32_pixel_size;if(i[_+rgb32_pixel_pad]==i[m+rgb32_pixel_pad]&&h!=a&&a>2&&n[_+rgb32_pixel_pad]==n[g+rgb32_pixel_pad]){for(e.state.waitcnt=l-a,h=a,c=a+this.decode_run(e.state);c>a;a++){var m=a*rgb32_pixel_size,_=(a-1)*rgb32_pixel_size;n[m+rgb32_pixel_pad]=n[_+rgb32_pixel_pad]}if(a==s)return;l=a+e.state.waitcnt,p=1;break}f=e.buckets_ptrs[t.row[a-1]],u=golomb_decoding_8bpc(f.bestcode,this.io_word),t.row[a]=u.rc,n[m+rgb32_pixel_pad]=family_8bpc.xlatL2U[u.rc]+(n[_+rgb32_pixel_pad]+i[m+rgb32_pixel_pad]>>1)&o,this.decode_eatbits(u.codewordlen)}if(p)break;f.update_model_8bpc(e.state,t.row[l],r),l=a+(e.state.tabrand()&d)}for(;s>a&&!p;a++){var m=a*rgb32_pixel_size,_=(a-1)*rgb32_pixel_size,g=(a-2)*rgb32_pixel_size;if(i[_+rgb32_pixel_pad]==i[m+rgb32_pixel_pad]&&h!=a&&a>2&&n[_+rgb32_pixel_pad]==n[g+rgb32_pixel_pad]){for(e.state.waitcnt=l-a,h=a,c=a+this.decode_run(e.state);c>a;a++){var m=a*rgb32_pixel_size,_=(a-1)*rgb32_pixel_size;n[m+rgb32_pixel_pad]=n[_+rgb32_pixel_pad]}if(a==s)return;l=a+e.state.waitcnt,p=1;break}u=golomb_decoding_8bpc(e.buckets_ptrs[t.row[a-1]].bestcode,this.io_word),t.row[a]=u.rc,n[m+rgb32_pixel_pad]=family_8bpc.xlatL2U[u.rc]+(n[_+rgb32_pixel_pad]+i[m+rgb32_pixel_pad]>>1)&o,this.decode_eatbits(u.codewordlen)}if(!p)return e.state.waitcnt=l-s,void 0}},QuicEncoder.prototype.quic_four_uncompress_row=function(e,t,i){for(var n=8,a=255,s=e.correlate_row,r=0,o=this.width;wmimax>e.state.wmidx&&o>=e.state.wmileft;)e.state.wmileft&&(this.quic_four_uncompress_row_seg(e,s,t,i,r,r+e.state.wmileft,n,a),r+=e.state.wmileft,o-=e.state.wmileft),e.state.wmidx++,e.state.set_wm_trigger(),e.state.wmileft=wminext;o&&(this.quic_four_uncompress_row_seg(e,s,t,i,r,r+o,n,a),wmimax>e.state.wmidx&&(e.state.wmileft-=o))},QuicEncoder.prototype.quic_decode=function(e,t){var i;switch(this.type){case QUIC_IMAGE_TYPE_RGB32:case QUIC_IMAGE_TYPE_RGB24:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(e),this.rows_completed++,i=1;this.height>i;i++){var n=e;e=n.subarray(t),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(n,e),this.rows_completed++}break;case QUIC_IMAGE_TYPE_RGB16:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_RGBA:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(e),this.channels[3].correlate_row.zero=0,this.quic_four_uncompress_row0(this.channels[3],e),this.rows_completed++,i=1;this.height>i;i++){var n=e;e=n.subarray(t),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(n,e),this.channels[3].correlate_row.zero=this.channels[3].correlate_row.row[0],this.quic_four_uncompress_row(encoder.channels[3],n,e),this.rows_completed++}break;case QUIC_IMAGE_TYPE_GRAY:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),!1}return!0},QuicEncoder.prototype.simple_quic_decode=function(e){var t=4;if(!this.quic_decode_begin(e))return void 0;if(this.type!=QUIC_IMAGE_TYPE_RGB32&&this.type!=QUIC_IMAGE_TYPE_RGB24&&this.type!=QUIC_IMAGE_TYPE_RGBA)return void 0;var i=new Uint8Array(4*this.width*this.height);return i[0]=69,this.quic_decode(i,this.width*t)?i:void 0},SpiceQuic.prototype={from_dv:function(e,t,i){if(!encoder)throw"quic: no quic encoder";this.data_size=e.getUint32(t,!0),t+=4;var n=new Uint8Array(i.slice(t));return this.outptr=encoder.simple_quic_decode(n),this.outptr&&(this.type=encoder.type,this.width=encoder.width,this.height=encoder.height),t+=n.length}},need_init){need_init=!1,family_init(family_8bpc,8,DEFmaxclen),family_init(family_5bpc,5,DEFmaxclen);var i,j,k,l;for(j=k=1,l=8,i=0;256>i;++i)zeroLUT[i]=l,--k,0==k&&(k=j,--l,j*=2);if(encoder=new QuicEncoder,!encoder)throw"quic: failed to create encoder"}SpiceDataView.prototype={getUint8:function(e){return this.u8[e]},getUint16:function(e,t){var i=1,n=0;return t&&(i=0,n=1),this.u8[e+n]<<8|this.u8[e+i]},getUint32:function(e,t){var i=2,n=0;return t&&(i=0,n=2),this.getUint16(e+n,t)<<16|this.getUint16(e+i,t)},setUint8:function(e,t){this.u8[e]=255&t},setUint16:function(e,t,i){var n=1,a=0;i&&(n=0,a=1),this.u8[e+a]=(65535&t)>>8,this.u8[e+n]=255&t},setUint32:function(e,t,i){var n=2,a=0;i&&(n=0,a=2),this.setUint16(e+a,(4294967295&t)>>16,i),this.setUint16(e+n,65535&t,i)}},SpiceChannelId.prototype={from_dv:function(e,t){return this.type=e.getUint8(t,!0),t++,this.id=e.getUint8(t,!0),t++,t}},SpiceRect.prototype={from_dv:function(e,t){return this.top=e.getUint32(t,!0),t+=4,this.left=e.getUint32(t,!0),t+=4,this.bottom=e.getUint32(t,!0),t+=4,this.right=e.getUint32(t,!0),t+=4},is_same_size:function(e){return this.bottom-this.top==e.bottom-e.top&&this.right-this.left==e.right-e.left?!0:!1}},SpiceClipRects.prototype={from_dv:function(e,t,i){var n;for(this.num_rects=e.getUint32(t,!0),t+=4,this.num_rects>0&&(this.rects=[]),n=0;this.num_rects>n;n++)this.rects[n]=new SpiceRect,t=this.rects[n].from_dv(e,t,i);return t}},SpiceClip.prototype={from_dv:function(e,t,i){return this.type=e.getUint8(t,!0),t++,this.type==SPICE_CLIP_TYPE_RECTS&&(this.rects=new SpiceClipRects,t=this.rects.from_dv(e,t,i)),t}},SpiceImageDescriptor.prototype={from_dv:function(e,t){return this.id=e.getUint32(t,!0),t+=4,this.id+=e.getUint32(t,!0)<<32,t+=4,this.type=e.getUint8(t,!0),t++,this.flags=e.getUint8(t,!0),t++,this.width=e.getUint32(t,!0),t+=4,this.height=e.getUint32(t,!0),t+=4}},SpicePalette.prototype={from_dv:function(e,t){var i;for(this.unique=[],this.unique[0]=e.getUint32(t,!0),t+=4,this.unique[1]=e.getUint32(t,!0),t+=4,this.num_ents=e.getUint16(t,!0),t+=2,this.ents=[],i=0;this.num_ents>i;i++)this.ents[i]=e.getUint32(t,!0),t+=4;return t}},SpiceBitmap.prototype={from_dv:function(e,t,i){if(this.format=e.getUint8(t,!0),t++,this.flags=e.getUint8(t,!0),t++,this.x=e.getUint32(t,!0),t+=4,this.y=e.getUint32(t,!0),t+=4,this.stride=e.getUint32(t,!0),t+=4,this.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE)this.palette_id=[],this.palette_id[0]=e.getUint32(t,!0),t+=4,this.palette_id[1]=e.getUint32(t,!0),t+=4;else{var n=e.getUint32(t,!0);t+=4,0==n?this.palette=null:(this.palette=new SpicePalette,this.palette.from_dv(e,n,i))}return this.data=i.slice(t),t+=this.data.byteLength}},SpiceImage.prototype={from_dv:function(e,t,i){if(this.descriptor=new SpiceImageDescriptor,t=this.descriptor.from_dv(e,t,i),this.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){this.lz_rgb=new Object,this.lz_rgb.length=e.getUint32(t,!0),t+=4;var n=t;this.lz_rgb.magic="";for(var a=3;a>=0;a--)this.lz_rgb.magic+=String.fromCharCode(e.getUint8(t+a));t+=4,this.lz_rgb.version=e.getUint32(t),t+=4,this.lz_rgb.type=e.getUint32(t),t+=4,this.lz_rgb.width=e.getUint32(t),t+=4,this.lz_rgb.height=e.getUint32(t),t+=4,this.lz_rgb.stride=e.getUint32(t),t+=4,this.lz_rgb.top_down=e.getUint32(t),t+=4;var s=t-n;this.lz_rgb.data=i.slice(t,this.lz_rgb.length+t-s),t+=this.lz_rgb.data.byteLength}if(this.descriptor.type==SPICE_IMAGE_TYPE_BITMAP&&(this.bitmap=new SpiceBitmap,t=this.bitmap.from_dv(e,t,i)),this.descriptor.type==SPICE_IMAGE_TYPE_SURFACE&&(this.surface_id=e.getUint32(t,!0),t+=4),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG&&(this.jpeg=new Object,this.jpeg.data_size=e.getUint32(t,!0),t+=4,this.jpeg.data=i.slice(t),t+=this.jpeg.data.byteLength),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){this.jpeg_alpha=new Object,this.jpeg_alpha.flags=e.getUint8(t,!0),t+=1,this.jpeg_alpha.jpeg_size=e.getUint32(t,!0),t+=4,this.jpeg_alpha.data_size=e.getUint32(t,!0),t+=4,this.jpeg_alpha.data=i.slice(t,this.jpeg_alpha.jpeg_size+t),t+=this.jpeg_alpha.data.byteLength,this.jpeg_alpha.alpha=new Object,this.jpeg_alpha.alpha.length=this.jpeg_alpha.data_size-this.jpeg_alpha.jpeg_size;var n=t;this.jpeg_alpha.alpha.magic="";for(var a=3;a>=0;a--)this.jpeg_alpha.alpha.magic+=String.fromCharCode(e.getUint8(t+a));t+=4,this.jpeg_alpha.alpha.version=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.type=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.width=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.height=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.stride=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.top_down=e.getUint32(t),t+=4;var s=t-n;this.jpeg_alpha.alpha.data=i.slice(t,this.jpeg_alpha.alpha.length+t-s),t+=this.jpeg_alpha.alpha.data.byteLength}return this.descriptor.type==SPICE_IMAGE_TYPE_QUIC&&(this.quic=new SpiceQuic,t=this.quic.from_dv(e,t,i)),t}},SpiceQMask.prototype={from_dv:function(e,t,i){this.flags=e.getUint8(t,!0),t++,this.pos=new SpicePoint,t=this.pos.from_dv(e,t,i);var n=e.getUint32(t,!0);return t+=4,0==n?(this.bitmap=null,t):(this.bitmap=new SpiceImage,this.bitmap.from_dv(e,n,i))}},SpicePattern.prototype={from_dv:function(e,t,i){var n=e.getUint32(t,!0);return t+=4,0==n?this.pat=null:(this.pat=new SpiceImage,this.pat.from_dv(e,n,i)),this.pos=new SpicePoint,this.pos.from_dv(e,t,i)}},SpiceBrush.prototype={from_dv:function(e,t,i){return this.type=e.getUint8(t,!0),t++,this.type==SPICE_BRUSH_TYPE_SOLID?(this.color=e.getUint32(t,!0),t+=4):this.type==SPICE_BRUSH_TYPE_PATTERN&&(this.pattern=new SpicePattern,t=this.pattern.from_dv(e,t,i)),t}},SpiceFill.prototype={from_dv:function(e,t,i){return this.brush=new SpiceBrush,t=this.brush.from_dv(e,t,i),this.rop_descriptor=e.getUint16(t,!0),t+=2,this.mask=new SpiceQMask,this.mask.from_dv(e,t,i)}},SpiceCopy.prototype={from_dv:function(e,t,i){var n=e.getUint32(t,!0);return t+=4,0==n?this.src_bitmap=null:(this.src_bitmap=new SpiceImage,this.src_bitmap.from_dv(e,n,i)),this.src_area=new SpiceRect,t=this.src_area.from_dv(e,t,i),this.rop_descriptor=e.getUint16(t,!0),t+=2,this.scale_mode=e.getUint8(t,!0),t++,this.mask=new SpiceQMask,this.mask.from_dv(e,t,i)}},SpicePoint16.prototype={from_dv:function(e,t){return this.x=e.getUint16(t,!0),t+=2,this.y=e.getUint16(t,!0),t+=2}},SpicePoint.prototype={from_dv:function(e,t){return this.x=e.getUint32(t,!0),t+=4,this.y=e.getUint32(t,!0),t+=4}},SpiceCursorHeader.prototype={from_dv:function(e,t){return this.unique=[],this.unique[0]=e.getUint32(t,!0),t+=4,this.unique[1]=e.getUint32(t,!0),t+=4,this.type=e.getUint8(t,!0),t++,this.width=e.getUint16(t,!0),t+=2,this.height=e.getUint16(t,!0),t+=2,this.hot_spot_x=e.getUint16(t,!0),t+=2,this.hot_spot_y=e.getUint16(t,!0),t+=2}},SpiceCursor.prototype={from_dv:function(e,t,i){return this.flags=e.getUint16(t,!0),t+=2,this.flags&SPICE_CURSOR_FLAGS_NONE?this.header=null:(this.header=new SpiceCursorHeader,t=this.header.from_dv(e,t,i),this.data=i.slice(t),t+=this.data.byteLength),t}},SpiceSurface.prototype={from_dv:function(e,t){return this.surface_id=e.getUint32(t,!0),t+=4,this.width=e.getUint32(t,!0),t+=4,this.height=e.getUint32(t,!0),t+=4,this.format=e.getUint32(t,!0),t+=4,this.flags=e.getUint32(t,!0),t+=4}},SpiceLinkHeader.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.magic="";for(var n=0;4>n;n++)this.magic+=String.fromCharCode(i.getUint8(t+n));t+=4,this.major_version=i.getUint32(t,!0),t+=4,this.minor_version=i.getUint32(t,!0),t+=4,this.size=i.getUint32(t,!0),t+=4},to_buffer:function(e,t){t=t||0;for(var i=new SpiceDataView(e),n=0;4>n;n++)i.setUint8(t+n,this.magic.charCodeAt(n));t+=4,i.setUint32(t,this.major_version,!0),t+=4,i.setUint32(t,this.minor_version,!0),t+=4,i.setUint32(t,this.size,!0),t+=4},buffer_size:function(){return 16}},SpiceLinkMess.prototype={from_buffer:function(e,t){t=t||0;var i,n=t,a=new SpiceDataView(e);this.connection_id=a.getUint32(t,!0),t+=4,this.channel_type=a.getUint8(t,!0),t++,this.channel_id=a.getUint8(t,!0),t++;var s=a.getUint32(t,!0);t+=4;var r=a.getUint32(t,!0);t+=4;var o=a.getUint32(t,!0);for(t+=4,t=n+o,this.common_caps=[],i=0;s>i;i++)this.common_caps.unshift(a.getUint32(t,!0)),t+=4;for(this.channel_caps=[],i=0;r>i;i++)this.channel_caps.unshift(a.getUint32(t,!0)),t+=4},to_buffer:function(e,t){t=t||0;var i,n=t,a=new SpiceDataView(e);for(a.setUint32(t,this.connection_id,!0),t+=4,a.setUint8(t,this.channel_type,!0),t++,a.setUint8(t,this.channel_id,!0),t++,a.setUint32(t,this.common_caps.length,!0),t+=4,a.setUint32(t,this.channel_caps.length,!0),t+=4,a.setUint32(t,t-n+4,!0),t+=4,i=0;this.common_caps.length>i;i++)a.setUint32(t,this.common_caps[i],!0),t+=4;for(i=0;this.channel_caps.length>i;i++)a.setUint32(t,this.channel_caps[i],!0),t+=4},buffer_size:function(){return 18+4*this.common_caps.length+4*this.channel_caps.length}},SpiceLinkReply.prototype={from_buffer:function(e,t){t=t||0;var i,n=t,a=new SpiceDataView(e);this.error=a.getUint32(t,!0),t+=4,this.pub_key=create_rsa_from_mb(e,t),t+=SPICE_TICKET_PUBKEY_BYTES;var s=a.getUint32(t,!0);t+=4;var r=a.getUint32(t,!0);t+=4;var o=a.getUint32(t,!0);for(t+=4,t=n+o,this.common_caps=[],i=0;s>i;i++)this.common_caps.unshift(a.getUint32(t,!0)),t+=4;for(this.channel_caps=[],i=0;r>i;i++)this.channel_caps.unshift(a.getUint32(t,!0)),t+=4}},SpiceLinkAuthTicket.prototype={to_buffer:function(e,t){t=t||0;var i,n=new SpiceDataView(e);for(n.setUint32(t,this.auth_mechanism,!0),t+=4,i=0;SPICE_TICKET_KEY_PAIR_LENGTH/8>i;i++)this.encrypted_data&&this.encrypted_data.length>i?n.setUint8(t,this.encrypted_data[i],!0):n.setUint8(t,0,!0),t++},buffer_size:function(){return 4+SPICE_TICKET_KEY_PAIR_LENGTH/8}},SpiceLinkAuthReply.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.auth_code=i.getUint32(t,!0),t+=4},buffer_size:function(){return 4}},SpiceMiniData.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.type=i.getUint16(t,!0),t+=2,this.size=i.getUint32(t,!0),t+=4,e.byteLength>t&&(this.data=e.slice(t),t+=this.data.byteLength)},to_buffer:function(e,t){t=t||0;var i,n=new SpiceDataView(e);if(n.setUint16(t,this.type,!0),t+=2,n.setUint32(t,this.data?this.data.byteLength:0,!0),t+=4,this.data&&this.data.byteLength>0){var a=new Uint8Array(this.data);for(i=0;a.length>i;i++,t++)n.setUint8(t,a[i],!0)}},build_msg:function(e,t){this.type=e,this.size=t.buffer_size(),this.data=new ArrayBuffer(this.size),t.to_buffer(this.data)},buffer_size:function(){return this.data?6+this.data.byteLength:6}},SpiceMsgChannels.prototype={from_buffer:function(e,t){t=t||0;var i,n=new SpiceDataView(e);for(this.num_of_channels=n.getUint32(t,!0),t+=4,i=0;this.num_of_channels>i;i++){var a=new SpiceChannelId;t=a.from_dv(n,t,e),this.channels.push(a)}}},SpiceMsgMainInit.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.session_id=i.getUint32(t,!0),t+=4,this.display_channels_hint=i.getUint32(t,!0),t+=4,this.supported_mouse_modes=i.getUint32(t,!0),t+=4,this.current_mouse_mode=i.getUint32(t,!0),t+=4,this.agent_connected=i.getUint32(t,!0),t+=4,this.agent_tokens=i.getUint32(t,!0),t+=4,this.multi_media_time=i.getUint32(t,!0),t+=4,this.ram_hint=i.getUint32(t,!0),t+=4}},SpiceMsgMainMouseMode.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.supported_modes=i.getUint16(t,!0),t+=2,this.current_mode=i.getUint16(t,!0),t+=2}},SpiceMsgSetAck.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.generation=i.getUint32(t,!0),t+=4,this.window=i.getUint32(t,!0),t+=4}},SpiceMsgcAckSync.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.generation,!0),t+=4},buffer_size:function(){return 4}},SpiceMsgcMainMouseModeRequest.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint16(t,this.mode,!0),t+=2},buffer_size:function(){return 2}},SpiceMsgNotify.prototype={from_buffer:function(e,t){t=t||0;var i,n=new SpiceDataView(e);for(this.time_stamp=[],this.time_stamp[0]=n.getUint32(t,!0),t+=4,this.time_stamp[1]=n.getUint32(t,!0),t+=4,this.severity=n.getUint32(t,!0),t+=4,this.visibility=n.getUint32(t,!0),t+=4,this.what=n.getUint32(t,!0),t+=4,this.message_len=n.getUint32(t,!0),t+=4,this.message="",i=0;this.message_len>i;i++){var a=n.getUint8(t,!0);t++,this.message+=String.fromCharCode(a)}}},SpiceMsgcDisplayInit.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint8(t,this.pixmap_cache_id,!0),t++,i.setUint32(t,0,!0),t+=4,i.setUint32(t,this.pixmap_cache_size,!0),t+=4,i.setUint8(t,this.glz_dictionary_id,!0),t++,i.setUint32(t,this.glz_dictionary_window_size,!0),t+=4},buffer_size:function(){return 14}},SpiceMsgDisplayBase.prototype={from_dv:function(e,t,i){return this.surface_id=e.getUint32(t,!0),t+=4,this.box=new SpiceRect,t=this.box.from_dv(e,t,i),this.clip=new SpiceClip,this.clip.from_dv(e,t,i)
}},SpiceMsgDisplayDrawCopy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.data=new SpiceCopy,this.data.from_dv(i,t,e)}},SpiceMsgDisplayDrawFill.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.data=new SpiceFill,this.data.from_dv(i,t,e)}},SpiceMsgDisplayCopyBits.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.src_pos=new SpicePoint,this.src_pos.from_dv(i,t,e)}},SpiceMsgSurfaceCreate.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.surface=new SpiceSurface,this.surface.from_dv(i,t,e)}},SpiceMsgSurfaceDestroy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.surface_id=i.getUint32(t,!0),t+=4}},SpiceMsgInputsInit.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.keyboard_modifiers=i.getUint16(t,!0),t+=2}},SpiceMsgInputsKeyModifiers.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.keyboard_modifiers=i.getUint16(t,!0),t+=2}},SpiceMsgCursorInit.prototype={from_buffer:function(e,t,i){t=t||0;var n=new SpiceDataView(e);return this.position=new SpicePoint16,t=this.position.from_dv(n,t,i),this.trail_length=n.getUint16(t,!0),t+=2,this.trail_frequency=n.getUint16(t,!0),t+=2,this.visible=n.getUint8(t,!0),t++,this.cursor=new SpiceCursor,this.cursor.from_dv(n,t,e)}},SpiceMsgCursorSet.prototype={from_buffer:function(e,t,i){t=t||0;var n=new SpiceDataView(e);return this.position=new SpicePoint16,t=this.position.from_dv(n,t,i),this.visible=n.getUint8(t,!0),t++,this.cursor=new SpiceCursor,this.cursor.from_dv(n,t,e)}},SpiceMsgcMousePosition.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint32(t,this.x,!0),t+=4,i.setUint32(t,this.y,!0),t+=4,i.setUint16(t,this.buttons_state,!0),t+=2,i.setUint8(t,this.display_id,!0),t+=1},buffer_size:function(){return 11}},SpiceMsgcMouseMotion.prototype.to_buffer=SpiceMsgcMousePosition.prototype.to_buffer,SpiceMsgcMouseMotion.prototype.buffer_size=SpiceMsgcMousePosition.prototype.buffer_size,SpiceMsgcMousePress.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint8(t,this.button,!0),t++,i.setUint16(t,this.buttons_state,!0),t+=2},buffer_size:function(){return 3}},SpiceMsgcMouseRelease.prototype.to_buffer=SpiceMsgcMousePress.prototype.to_buffer,SpiceMsgcMouseRelease.prototype.buffer_size=SpiceMsgcMousePress.prototype.buffer_size,SpiceMsgcKeyDown.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint32(t,this.code,!0),t+=4},buffer_size:function(){return 4}},SpiceMsgcKeyUp.prototype.to_buffer=SpiceMsgcKeyDown.prototype.to_buffer,SpiceMsgcKeyUp.prototype.buffer_size=SpiceMsgcKeyDown.prototype.buffer_size,SpiceMsgDisplayStreamCreate.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.surface_id=i.getUint32(t,!0),t+=4,this.id=i.getUint32(t,!0),t+=4,this.flags=i.getUint8(t,!0),t+=1,this.codec_type=i.getUint8(t,!0),t+=1,t+=8,this.stream_width=i.getUint32(t,!0),t+=4,this.stream_height=i.getUint32(t,!0),t+=4,this.src_width=i.getUint32(t,!0),t+=4,this.src_height=i.getUint32(t,!0),t+=4,this.dest=new SpiceRect,t=this.dest.from_dv(i,t,e),this.clip=new SpiceClip,this.clip.from_dv(i,t,e)}},SpiceStreamDataHeader.prototype={from_dv:function(e,t){return this.id=e.getUint32(t,!0),t+=4,this.multi_media_time=e.getUint32(t,!0),t+=4}},SpiceMsgDisplayStreamData.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.base=new SpiceStreamDataHeader,t=this.base.from_dv(i,t,e),this.data_size=i.getUint32(t,!0),t+=4,this.data=i.u8.subarray(t,t+this.data_size)}},SpiceMsgDisplayStreamClip.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.id=i.getUint32(t,!0),t+=4,this.clip=new SpiceClip,this.clip.from_dv(i,t,e)}},SpiceMsgDisplayStreamDestroy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.id=i.getUint32(t,!0),t+=4}},SpiceWireReader.prototype={inbound:function(e){if(0==this.needed)return this.buffers.push(e),void 0;for(0==this.buffers.length&&e.byteLength>=this.needed?(e.byteLength>this.needed&&(this.buffers.push(e.slice(this.needed)),e=e.slice(0,this.needed)),this.callback.call(this.sc,e,this.saved_msg_header||void 0)):this.buffers.push(e);this.buffers.length>1&&this.buffers[0].byteLength<this.needed;){var t=this.buffers.shift(),i=this.buffers.shift();this.buffers.unshift(combine_array_buffers(t,i))}for(;this.buffers.length>0&&this.buffers[0].byteLength>=this.needed;)e=this.buffers.shift(),e.byteLength>this.needed&&(this.buffers.unshift(e.slice(this.needed)),e=e.slice(0,this.needed)),this.callback.call(this.sc,e,this.saved_msg_header||void 0)},request:function(e){this.needed=e},save_header:function(e){this.saved_msg_header=e},clear_header:function(){this.saved_msg_header=void 0}},SpiceConn.prototype={send_hdr:function(){var e=new SpiceLinkHeader,t=new SpiceLinkMess;t.connection_id=this.connection_id,t.channel_type=this.type,t.common_caps.push(1<<SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION|1<<SPICE_COMMON_CAP_MINI_HEADER),e.size=t.buffer_size();var i=new ArrayBuffer(e.buffer_size()+t.buffer_size());e.to_buffer(i),t.to_buffer(i,e.buffer_size()),DEBUG>1&&console.log("Sending header:"),DEBUG>2&&hexdump_buffer(i),this.ws.send(i)},send_ticket:function(e){var t=new SpiceLinkAuthTicket;t.auth_mechanism=SPICE_COMMON_CAP_AUTH_SPICE,t.encrypted_data=e;var i=new ArrayBuffer(t.buffer_size());t.to_buffer(i),DEBUG>1&&console.log("Sending ticket:"),DEBUG>2&&hexdump_buffer(i),this.ws.send(i)},send_msg:function(e){var t=new ArrayBuffer(e.buffer_size());e.to_buffer(t),this.messages_sent++,DEBUG>0&&console.log(">> hdr "+this.channel_type()+" type "+e.type+" size "+t.byteLength),DEBUG>2&&hexdump_buffer(t),this.ws.send(t)},process_inbound:function(e,t){if(DEBUG>2&&console.log(this.type+": processing message of size "+e.byteLength+"; state is "+this.state),"ready"==this.state)if(void 0==t){var i=new SpiceMiniData(e);i.type>500&&alert("Something has gone very wrong; we think we have message of type "+i.type),0==i.size?(this.process_message(i),this.wire_reader.request(SpiceMiniData.prototype.buffer_size())):(this.wire_reader.request(i.size),this.wire_reader.save_header(i))}else t.data=e,this.process_message(t),this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.wire_reader.save_header(void 0);else if("start"==this.state)if(this.reply_hdr=new SpiceLinkHeader(e),this.reply_hdr.magic!=SPICE_MAGIC){this.state="error";var n=new Error("Error: magic mismatch: "+this.reply_hdr.magic);this.report_error(n)}else this.wire_reader.request(this.reply_hdr.size),this.state="link";else if("link"==this.state)if(this.reply_link=new SpiceLinkReply(e),this.reply_link.error){this.state="error";var n=new Error("Error: reply link error "+this.reply_link.error);this.report_error(n)}else this.send_ticket(rsa_encrypt(this.reply_link.pub_key,this.password+String.fromCharCode(0))),this.state="ticket",this.wire_reader.request(SpiceLinkAuthReply.prototype.buffer_size());else if("ticket"==this.state)if(this.auth_reply=new SpiceLinkAuthReply(e),this.auth_reply.auth_code==SPICE_LINK_ERR_OK){if(DEBUG>0&&console.log(this.type+": Connected"),this.type==SPICE_CHANNEL_DISPLAY){var a=new SpiceMsgcDisplayInit,s=new SpiceMiniData;s.build_msg(SPICE_MSGC_DISPLAY_INIT,a),DEBUG>0&&console.log("Request display init"),this.send_msg(s)}this.state="ready",this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout)}else{if(this.state="error",this.auth_reply.auth_code==SPICE_LINK_ERR_PERMISSION_DENIED)var n=new Error("Permission denied.");else var n=new Error("Unexpected link error "+this.auth_reply.auth_code);this.report_error(n)}},process_common_messages:function(e){if(e.type==SPICE_MSG_SET_ACK){var t=new SpiceMsgSetAck(e.data);this.ack_window=t.window,DEBUG>1&&console.log(this.type+": set ack to "+t.window),this.msgs_until_ack=this.ack_window;var i=new SpiceMsgcAckSync(t),n=new SpiceMiniData;return n.build_msg(SPICE_MSGC_ACK_SYNC,i),this.send_msg(n),!0}if(e.type==SPICE_MSG_PING){DEBUG>1&&console.log("ping!");var a=new SpiceMiniData;return a.type=SPICE_MSGC_PONG,e.data&&(a.data=e.data.slice(0,12)),a.size=a.buffer_size(),this.send_msg(a),!0}if(e.type==SPICE_MSG_NOTIFY){var s=new SpiceMsgNotify(e.data);return s.severity==SPICE_NOTIFY_SEVERITY_ERROR?this.log_err(s.message):s.severity==SPICE_NOTIFY_SEVERITY_WARN?this.log_warn(s.message):this.log_info(s.message),!0}return!1},process_message:function(e){var t;if(DEBUG>0&&console.log("<< hdr "+this.channel_type()+" type "+e.type+" size "+(e.data&&e.data.byteLength)),t=this.process_common_messages(e))return t;if(!this.process_channel_message)return this.log_err(this.type+": No message handlers for this channel; message "+e.type),!1;if(t=this.process_channel_message(e),t||this.log_warn(this.type+": Unknown message type "+e.type+"!"),void 0!==this.msgs_until_ack&&this.ack_window&&(this.msgs_until_ack--,0>=this.msgs_until_ack)){this.msgs_until_ack=this.ack_window;var i=new SpiceMiniData;i.type=SPICE_MSGC_ACK,this.send_msg(i),DEBUG>1&&console.log(this.type+": sent ack")}return t},channel_type:function(){return this.type==SPICE_CHANNEL_MAIN?"main":this.type==SPICE_CHANNEL_DISPLAY?"display":this.type==SPICE_CHANNEL_INPUTS?"inputs":this.type==SPICE_CHANNEL_CURSOR?"cursor":"unknown-"+this.type},log_info:function(){var e=Array.prototype.join.call(arguments," ");if(console.log(e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-info",document.getElementById(this.message_id).appendChild(t)}},log_warn:function(){var e=Array.prototype.join.call(arguments," ");if(console.log("WARNING: "+e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-warning",document.getElementById(this.message_id).appendChild(t)}},log_err:function(){var e=Array.prototype.join.call(arguments," ");if(console.log("ERROR: "+e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-error",document.getElementById(this.message_id).appendChild(t)}},known_unimplemented:function(e,t){if(!this.warnings[e]||DEBUG>1){var i="";1>=DEBUG&&(i=" [ further notices suppressed ]"),this.log_warn("Unimplemented function "+e+"("+t+")"+i),this.warnings[e]=!0}},report_error:function(e){if(this.log_err(e.toString()),void 0==this.onerror)throw e;this.onerror(e)},report_success:function(e){void 0!=this.onsuccess&&this.onsuccess(e)},cleanup:function(){this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout),this.ws&&(this.ws.close(),this.ws=void 0)},handle_timeout:function(){var e=new Error("Connection timed out.");this.report_error(e)}},SpiceDisplayConn.prototype=Object.create(SpiceConn.prototype),SpiceDisplayConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_DISPLAY_MARK)return this.known_unimplemented(e.type,"Display Mark"),!0;if(e.type==SPICE_MSG_DISPLAY_RESET)return DEBUG>2&&console.log("Display reset"),this.surfaces[this.primary_surface].canvas.context.restore(),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_COPY){var t=new SpiceMsgDisplayDrawCopy(e.data);if(DEBUG>1&&this.log_draw("DrawCopy",t),t.base.box.is_same_size(t.data.src_area)||this.log_warn("FIXME: DrawCopy src_area is a different size than base.box; we do not handle that yet."),t.base.clip.type!=SPICE_CLIP_TYPE_NONE&&this.log_warn("FIXME: DrawCopy we don't handle clipping yet"),t.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawCopy we don't handle ropd type: "+t.data.rop_descriptor),t.data.mask.flags&&this.log_warn("FIXME: DrawCopy we don't handle mask flag: "+t.data.mask.flags),t.data.mask.bitmap&&this.log_warn("FIXME: DrawCopy we don't handle mask"),t.data&&t.data.src_bitmap){if(t.data.src_bitmap.descriptor.flags&&t.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_CACHE_ME&&t.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_HIGH_BITS_SET&&(this.log_warn("FIXME: DrawCopy unhandled image flags: "+t.data.src_bitmap.descriptor.flags),1>=DEBUG&&this.log_draw("DrawCopy",t)),t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_QUIC){var i=this.surfaces[t.base.surface_id].canvas;if(!t.data.src_bitmap.quic)return this.log_warn("FIXME: DrawCopy could not handle this QUIC file."),!1;var n=convert_spice_quic_to_web(i.context,t.data.src_bitmap.quic);return this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:n,tag:"copyquic."+t.data.src_bitmap.quic.type,has_alpha:t.data.src_bitmap.quic.type==QUIC_IMAGE_TYPE_RGBA?!0:!1,descriptor:t.data.src_bitmap.descriptor})}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE||t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS)return this.cache&&this.cache[t.data.src_bitmap.descriptor.id]?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:this.cache[t.data.src_bitmap.descriptor.id],tag:"copycache."+t.data.src_bitmap.descriptor.id,has_alpha:!0,descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: DrawCopy did not find image id "+t.data.src_bitmap.descriptor.id+" in cache."),!1);if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_SURFACE){var a=this.surfaces[t.data.src_bitmap.surface_id].canvas.context;this.surfaces[t.base.surface_id].canvas.context;var n=a.getImageData(t.data.src_area.left,t.data.src_area.top,t.data.src_area.right-t.data.src_area.left,t.data.src_area.bottom-t.data.src_area.top),s=new SpiceRect;return s.top=s.left=0,s.right=n.width,s.bottom=n.height,this.draw_copy_helper({base:t.base,src_area:s,image_data:n,tag:"copysurf."+t.data.src_bitmap.surface_id,has_alpha:this.surfaces[t.data.src_bitmap.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?!1:!0,descriptor:t.data.src_bitmap.descriptor})}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG){if(!t.data.src_bitmap.jpeg)return this.log_warn("FIXME: DrawCopy could not handle this JPEG file."),!1;var r,o="data:image/jpeg,",l=new Image,c=new Uint8Array(t.data.src_bitmap.jpeg.data);for(r=0;c.length>r;r++)o+="%",16>c[r]&&(o+="0"),o+=c[r].toString(16);return l.o={base:t.base,tag:"jpeg."+t.data.src_bitmap.surface_id,descriptor:t.data.src_bitmap.descriptor,sc:this},l.onload=handle_draw_jpeg_onload,l.src=o,!0}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){if(!t.data.src_bitmap.jpeg_alpha)return this.log_warn("FIXME: DrawCopy could not handle this JPEG ALPHA file."),!1;var r,o="data:image/jpeg,",l=new Image,c=new Uint8Array(t.data.src_bitmap.jpeg_alpha.data);for(r=0;c.length>r;r++)o+="%",16>c[r]&&(o+="0"),o+=c[r].toString(16);if(l.o={base:t.base,tag:"jpeg."+t.data.src_bitmap.surface_id,descriptor:t.data.src_bitmap.descriptor,sc:this},this.surfaces[t.base.surface_id].format==SPICE_SURFACE_FMT_32_ARGB){var i=this.surfaces[t.base.surface_id].canvas;l.alpha_img=convert_spice_lz_to_web(i.context,t.data.src_bitmap.jpeg_alpha.alpha)}return l.onload=handle_draw_jpeg_onload,l.src=o,!0}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_BITMAP){var i=this.surfaces[t.base.surface_id].canvas;if(!t.data.src_bitmap.bitmap)return this.log_err("null bitmap"),!1;var n=convert_spice_bitmap_to_web(i.context,t.data.src_bitmap.bitmap);return n?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:n,tag:"bitmap."+t.data.src_bitmap.bitmap.format,has_alpha:t.data.src_bitmap.bitmap==SPICE_BITMAP_FMT_32BIT?!1:!0,descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of format: "+t.data.src_bitmap.bitmap.format),!1)}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){var i=this.surfaces[t.base.surface_id].canvas;if(!t.data.src_bitmap.lz_rgb)return this.log_err("null lz_rgb "),!1;1!=t.data.src_bitmap.lz_rgb.top_down&&this.log_warn("FIXME: Implement non top down support for lz_rgb");var n=convert_spice_lz_to_web(i.context,t.data.src_bitmap.lz_rgb);return n?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:n,tag:"lz_rgb."+t.data.src_bitmap.lz_rgb.type,has_alpha:t.data.src_bitmap.lz_rgb.type==LZ_IMAGE_TYPE_RGBA?!0:!1,descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of type: "+t.data.src_bitmap.lz_rgb.type),!1)}return this.log_warn("FIXME: DrawCopy unhandled image type: "+t.data.src_bitmap.descriptor.type),this.log_draw("DrawCopy",t),!1}return this.log_warn("FIXME: DrawCopy no src_bitmap."),!1}if(e.type==SPICE_MSG_DISPLAY_DRAW_FILL){var u=new SpiceMsgDisplayDrawFill(e.data);if(DEBUG>1&&this.log_draw("DrawFill",u),u.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawFill we don't handle ropd type: "+u.data.rop_descriptor),u.data.mask.flags&&this.log_warn("FIXME: DrawFill we don't handle mask flag: "+u.data.mask.flags),u.data.mask.bitmap&&this.log_warn("FIXME: DrawFill we don't handle mask"),u.data.brush.type==SPICE_BRUSH_TYPE_SOLID){var d=16777215&u.data.brush.color,h="rgb("+(d>>16)+", "+(255&d>>8)+", "+(255&d)+")";if(this.surfaces[u.base.surface_id].canvas.context.fillStyle=h,this.surfaces[u.base.surface_id].canvas.context.fillRect(u.base.box.left,u.base.box.top,u.base.box.right-u.base.box.left,u.base.box.bottom-u.base.box.top),DUMP_DRAWS&&this.parent.dump_id){var p=document.createElement("canvas");p.setAttribute("width",this.surfaces[u.base.surface_id].canvas.width),p.setAttribute("height",this.surfaces[u.base.surface_id].canvas.height),p.setAttribute("id","fillbrush."+u.base.surface_id+"."+this.surfaces[u.base.surface_id].draw_count),p.getContext("2d").fillStyle=h,p.getContext("2d").fillRect(u.base.box.left,u.base.box.top,u.base.box.right-u.base.box.left,u.base.box.bottom-u.base.box.top),document.getElementById(this.parent.dump_id).appendChild(p)}this.surfaces[u.base.surface_id].draw_count++}else this.log_warn("FIXME: DrawFill can't handle brush type: "+u.data.brush.type);return!0}if(e.type==SPICE_MSG_DISPLAY_COPY_BITS){var f=new SpiceMsgDisplayCopyBits(e.data);DEBUG>1&&this.log_draw("CopyBits",f);var m=this.surfaces[f.base.surface_id].canvas,a=m.context,_=m.width-f.src_pos.x,g=m.height-f.src_pos.y;_>f.base.box.right-f.base.box.left&&(_=f.base.box.right-f.base.box.left),g>f.base.box.bottom-f.base.box.top&&(g=f.base.box.bottom-f.base.box.top);var n=a.getImageData(f.src_pos.x,f.src_pos.y,_,g);if(putImageDataWithAlpha(a,n,f.base.box.left,f.base.box.top),DUMP_DRAWS&&this.parent.dump_id){var p=document.createElement("canvas");p.setAttribute("width",_),p.setAttribute("height",g),p.setAttribute("id","copybits"+f.base.surface_id+"."+this.surfaces[f.base.surface_id].draw_count),p.getContext("2d").putImageData(n,0,0),document.getElementById(this.parent.dump_id).appendChild(p)}return this.surfaces[f.base.surface_id].draw_count++,!0}if(e.type==SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES)return this.known_unimplemented(e.type,"Inval All Palettes"),!0;if(e.type==SPICE_MSG_DISPLAY_SURFACE_CREATE){"surfaces"in this||(this.surfaces=[]);var b=new SpiceMsgSurfaceCreate(e.data);if(DEBUG>1&&console.log(this.type+": MsgSurfaceCreate id "+b.surface.surface_id+"; "+b.surface.width+"x"+b.surface.height+"; format "+b.surface.format+"; flags "+b.surface.flags),b.surface.format!=SPICE_SURFACE_FMT_32_xRGB&&b.surface.format!=SPICE_SURFACE_FMT_32_ARGB)return this.log_warn("FIXME: cannot handle surface format "+b.surface.format+" yet."),!1;var i=document.createElement("canvas");return i.setAttribute("width",b.surface.width),i.setAttribute("height",b.surface.height),i.setAttribute("id","spice_surface_"+b.surface.surface_id),i.setAttribute("tabindex",b.surface.surface_id),i.context=i.getContext("2d"),DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).appendChild(i),b.surface.canvas=i,b.surface.draw_count=0,this.surfaces[b.surface.surface_id]=b.surface,b.surface.flags&SPICE_SURFACE_FLAGS_PRIMARY&&(this.primary_surface=b.surface.surface_id,i.context.save(),document.getElementById(this.parent.screen_id).appendChild(i),document.getElementById(this.parent.screen_id).setAttribute("width",b.surface.width),document.getElementById(this.parent.screen_id).setAttribute("height",b.surface.height),this.hook_events()),!0}if(e.type==SPICE_MSG_DISPLAY_SURFACE_DESTROY){var b=new SpiceMsgSurfaceDestroy(e.data);return DEBUG>1&&console.log(this.type+": MsgSurfaceDestroy id "+b.surface_id),this.delete_surface(b.surface_id),!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_CREATE){var b=new SpiceMsgDisplayStreamCreate(e.data);return DEBUG>1&&console.log(this.type+": MsgStreamCreate id"+b.id),this.streams||(this.streams=new Array),this.streams[b.id]?console.log("Stream already exists"):this.streams[b.id]=b,b.codec_type!=SPICE_VIDEO_CODEC_TYPE_MJPEG&&console.log("Unhandled stream codec: "+b.codec_type),!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_DATA){var b=new SpiceMsgDisplayStreamData(e.data);if(!this.streams[b.base.id])return console.log("no stream for data"),!1;if(this.streams[b.base.id].codec_type===SPICE_VIDEO_CODEC_TYPE_MJPEG){var r,o="data:image/jpeg,",l=new Image;for(r=0;b.data.length>r;r++)o+="%",16>b.data[r]&&(o+="0"),o+=b.data[r].toString(16);var v=new SpiceMsgDisplayBase;v.surface_id=this.streams[b.base.id].surface_id,v.box=this.streams[b.base.id].dest,v.clip=this.streams[b.base.id].clip,l.o={base:v,tag:"mjpeg."+b.base.id,descriptor:null,sc:this},l.onload=handle_draw_jpeg_onload,l.src=o}return!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_CLIP){var b=new SpiceMsgDisplayStreamClip(e.data);return DEBUG>1&&console.log(this.type+": MsgStreamClip id"+b.id),this.streams[b.id].clip=b.clip,!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_DESTROY){var b=new SpiceMsgDisplayStreamDestroy(e.data);return DEBUG>1&&console.log(this.type+": MsgStreamDestroy id"+b.id),this.streams[b.id]=void 0,!0}return!1},SpiceDisplayConn.prototype.delete_surface=function(e){var t=document.getElementById("spice_surface_"+e);DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).removeChild(t),this.primary_surface==e&&(this.unhook_events(),this.primary_surface=void 0,document.getElementById(this.parent.screen_id).removeChild(t)),delete this.surfaces[e]},SpiceDisplayConn.prototype.draw_copy_helper=function(e){var t=this.surfaces[e.base.surface_id].canvas;if(e.has_alpha?this.surfaces[e.base.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?(stripAlpha(e.image_data),t.context.putImageData(e.image_data,e.base.box.left,e.base.box.top)):putImageDataWithAlpha(t.context,e.image_data,e.base.box.left,e.base.box.top):t.context.putImageData(e.image_data,e.base.box.left,e.base.box.top),(e.src_area.left>0||e.src_area.top>0)&&this.log_warn("FIXME: DrawCopy not shifting draw copies just yet..."),e.descriptor&&e.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this||(this.cache=[]),this.cache[e.descriptor.id]=e.image_data),DUMP_DRAWS&&this.parent.dump_id){var i=document.createElement("canvas");i.setAttribute("width",e.image_data.width),i.setAttribute("height",e.image_data.height),i.setAttribute("id",e.tag+"."+this.surfaces[e.base.surface_id].draw_count+"."+e.base.surface_id+"@"+e.base.box.left+"x"+e.base.box.top),i.getContext("2d").putImageData(e.image_data,0,0),document.getElementById(this.parent.dump_id).appendChild(i)}return this.surfaces[e.base.surface_id].draw_count++,!0},SpiceDisplayConn.prototype.log_draw=function(e,t){var i=e+"."+t.base.surface_id+"."+this.surfaces[t.base.surface_id].draw_count+": ";i+="base.box "+t.base.box.left+", "+t.base.box.top+" to "+t.base.box.right+", "+t.base.box.bottom,i+="; clip.type "+t.base.clip.type,t.data&&(t.data.src_area&&(i+="; src_area "+t.data.src_area.left+", "+t.data.src_area.top+" to "+t.data.src_area.right+", "+t.data.src_area.bottom),t.data.src_bitmap&&null!=t.data.src_bitmap?(i+="; src_bitmap id: "+t.data.src_bitmap.descriptor.id,i+="; src_bitmap width "+t.data.src_bitmap.descriptor.width+", height "+t.data.src_bitmap.descriptor.height,i+="; src_bitmap type "+t.data.src_bitmap.descriptor.type+", flags "+t.data.src_bitmap.descriptor.flags,void 0!==t.data.src_bitmap.surface_id&&(i+="; src_bitmap surface_id "+t.data.src_bitmap.surface_id),t.data.src_bitmap.quic&&(i+="; QUIC type "+t.data.src_bitmap.quic.type+"; width "+t.data.src_bitmap.quic.width+"; height "+t.data.src_bitmap.quic.height),t.data.src_bitmap.lz_rgb&&(i+="; LZ_RGB length "+t.data.src_bitmap.lz_rgb.length+"; magic "+t.data.src_bitmap.lz_rgb.magic+"; version 0x"+t.data.src_bitmap.lz_rgb.version.toString(16)+"; type "+t.data.src_bitmap.lz_rgb.type+"; width "+t.data.src_bitmap.lz_rgb.width+"; height "+t.data.src_bitmap.lz_rgb.height+"; stride "+t.data.src_bitmap.lz_rgb.stride+"; top down "+t.data.src_bitmap.lz_rgb.top_down)):i+="; src_bitmap is null",t.data.brush&&(t.data.brush.type==SPICE_BRUSH_TYPE_SOLID&&(i+="; brush.color 0x"+t.data.brush.color.toString(16)),t.data.brush.type==SPICE_BRUSH_TYPE_PATTERN&&(i+="; brush.pat ",i+=null!=t.data.brush.pattern.pat?"[SpiceImage]":"[null]",i+=" at "+t.data.brush.pattern.pos.x+", "+t.data.brush.pattern.pos.y)),i+="; rop_descriptor "+t.data.rop_descriptor,void 0!==t.data.scale_mode&&(i+="; scale_mode "+t.data.scale_mode),i+="; mask.flags "+t.data.mask.flags,i+="; mask.pos "+t.data.mask.pos.x+", "+t.data.mask.pos.y,null!=t.data.mask.bitmap?(i+="; mask.bitmap width "+t.data.mask.bitmap.descriptor.width+", height "+t.data.mask.bitmap.descriptor.height,i+="; mask.bitmap type "+t.data.mask.bitmap.descriptor.type+", flags "+t.data.mask.bitmap.descriptor.flags):i+="; mask.bitmap is null"),console.log(i)},SpiceDisplayConn.prototype.hook_events=function(){if(void 0!==this.primary_surface){var e=this.surfaces[this.primary_surface].canvas;e.sc=this.parent,e.addEventListener("mousemove",handle_mousemove),e.addEventListener("mousedown",handle_mousedown),e.addEventListener("contextmenu",handle_contextmenu),e.addEventListener("mouseup",handle_mouseup),e.addEventListener("keydown",handle_keydown),e.addEventListener("keyup",handle_keyup),e.addEventListener("mouseout",handle_mouseout),e.addEventListener("mouseover",handle_mouseover),e.addEventListener("mousewheel",handle_mousewheel),e.focus()}},SpiceDisplayConn.prototype.unhook_events=function(){if(void 0!==this.primary_surface){var e=this.surfaces[this.primary_surface].canvas;e.removeEventListener("mousemove",handle_mousemove),e.removeEventListener("mousedown",handle_mousedown),e.removeEventListener("contextmenu",handle_contextmenu),e.removeEventListener("mouseup",handle_mouseup),e.removeEventListener("keydown",handle_keydown),e.removeEventListener("keyup",handle_keyup),e.removeEventListener("mouseout",handle_mouseout),e.removeEventListener("mouseover",handle_mouseover),e.removeEventListener("mousewheel",handle_mousewheel)}},SpiceDisplayConn.prototype.destroy_surfaces=function(){for(var e in this.surfaces)this.delete_surface(this.surfaces[e].surface_id);this.surfaces=void 0},SpiceMainConn.prototype=Object.create(SpiceConn.prototype),SpiceMainConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_MAIN_INIT){if(this.log_info("Connected to "+this.ws.url),this.report_success("Connected"),this.main_init=new SpiceMsgMainInit(e.data),this.connection_id=this.main_init.session_id,DEBUG>0&&this.log_info("session id "+this.main_init.session_id+" ; display_channels_hint "+this.main_init.display_channels_hint+" ; supported_mouse_modes "+this.main_init.supported_mouse_modes+" ; current_mouse_mode "+this.main_init.current_mouse_mode+" ; agent_connected "+this.main_init.agent_connected+" ; agent_tokens "+this.main_init.agent_tokens+" ; multi_media_time "+this.main_init.multi_media_time+" ; ram_hint "+this.main_init.ram_hint),this.mouse_mode=this.main_init.current_mouse_mode,this.main_init.current_mouse_mode!=SPICE_MOUSE_MODE_CLIENT&&this.main_init.supported_mouse_modes&SPICE_MOUSE_MODE_CLIENT){var t=new SpiceMsgcMainMouseModeRequest(SPICE_MOUSE_MODE_CLIENT),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST,t),this.send_msg(i)}var n=new SpiceMiniData;return n.type=SPICE_MSGC_MAIN_ATTACH_CHANNELS,n.size=n.buffer_size(),this.send_msg(n),!0}if(e.type==SPICE_MSG_MAIN_MOUSE_MODE){var a=new SpiceMsgMainMouseMode(e.data);return DEBUG>0&&this.log_info("Mouse supported modes "+a.supported_modes+"; current "+a.current_mode),this.mouse_mode=a.current_mode,this.inputs&&(this.inputs.mouse_mode=a.current_mode),!0}if(e.type==SPICE_MSG_MAIN_CHANNELS_LIST){var s,r;for(DEBUG>0&&console.log("channels"),r=new SpiceMsgChannels(e.data),s=0;r.channels.length>s;s++){var o={uri:this.ws.url,parent:this,connection_id:this.connection_id,type:r.channels[s].type,chan_id:r.channels[s].id};r.channels[s].type==SPICE_CHANNEL_DISPLAY?this.display=new SpiceDisplayConn(o):r.channels[s].type==SPICE_CHANNEL_INPUTS?(this.inputs=new SpiceInputsConn(o),this.inputs.mouse_mode=this.mouse_mode):r.channels[s].type==SPICE_CHANNEL_CURSOR?this.cursor=new SpiceCursorConn(o):(this.log_err("Channel type "+r.channels[s].type+" unknown."),"extra_channels"in this||(this.extra_channels=[]),this.extra_channels[s]=new SpiceConn(o))}return!0}return!1},SpiceMainConn.prototype.stop=function(){if(this.state="closing",this.inputs&&(this.inputs.cleanup(),this.inputs=void 0),this.cursor&&(this.cursor.cleanup(),this.cursor=void 0),this.display&&(this.display.cleanup(),this.display.destroy_surfaces(),this.display=void 0),this.cleanup(),"extra_channels"in this)for(var e in this.extra_channels)this.extra_channels[e].cleanup();this.extra_channels=void 0};/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
var Shift_state=-1,Ctrl_state=-1,Alt_state=-1,Meta_state=-1;SpiceInputsConn.prototype=Object.create(SpiceConn.prototype),SpiceInputsConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_INPUTS_INIT){var t=new SpiceMsgInputsInit(e.data);return this.keyboard_modifiers=t.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsInit - modifier "+this.keyboard_modifiers),!0}if(e.type==SPICE_MSG_INPUTS_KEY_MODIFIERS){var i=new SpiceMsgInputsKeyModifiers(e.data);return this.keyboard_modifiers=i.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsKeyModifiers - modifier "+this.keyboard_modifiers),!0}return e.type==SPICE_MSG_INPUTS_MOUSE_MOTION_ACK?(DEBUG>1&&console.log("mouse motion ack"),this.waiting_for_ack-=SPICE_INPUT_MOTION_ACK_BUNCH,!0):!1},SpiceCursorConn.prototype=Object.create(SpiceConn.prototype),SpiceCursorConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_CURSOR_INIT){var t=new SpiceMsgCursorInit(e.data);return DEBUG>1&&console.log("SpiceMsgCursorInit"),this.parent&&this.parent.inputs&&this.parent.inputs.mouse_mode==SPICE_MOUSE_MODE_SERVER&&(this.parent.inputs.mousex=t.position.x,this.parent.inputs.mousey=t.position.y),!0}if(e.type==SPICE_MSG_CURSOR_SET){var i=new SpiceMsgCursorSet(e.data);return DEBUG>1&&console.log("SpiceMsgCursorSet"),i.flags&SPICE_CURSOR_FLAGS_NONE?(document.getElementById(this.parent.screen_id).style.cursor="none",!0):(i.flags>0&&this.log_warn("FIXME: No support for cursor flags "+i.flags),i.cursor.header.type!=SPICE_CURSOR_TYPE_ALPHA?(this.log_warn("FIXME: No support for cursor type "+i.cursor.header.type),!1):(this.set_cursor(i.cursor),!0))}return e.type==SPICE_MSG_CURSOR_HIDE?(DEBUG>1&&console.log("SpiceMsgCursorHide"),document.getElementById(this.parent.screen_id).style.cursor="none",!0):!1},SpiceCursorConn.prototype.set_cursor=function(e){var t=create_rgba_png(e.header.height,e.header.width,e.data),i="url(data:image/png,"+t+") "+e.header.hot_spot_x+" "+e.header.hot_spot_y+", default";document.getElementById(this.parent.screen_id).style.cursor=i};/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
var dbits,canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr,vv;for(rr="0".charCodeAt(0),vv=0;9>=vv;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_psize=256,rng_state,rng_pool,rng_pptr;if(null==rng_pool){rng_pool=new Array,rng_pptr=0;var t;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var z=window.crypto.random(32);for(t=0;z.length>t;++t)rng_pool[rng_pptr++]=255&z.charCodeAt(t)}for(;rng_psize>rng_pptr;)t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=255&t;rng_pptr=0,rng_seed_time()}SecureRandom.prototype.nextBytes=rng_get_bytes;/*
 * A JavaScript implementation of the Secure Hash Algorithm, SHA-1, as defined
 * in FIPS 180-1
 * Version 2.2 Copyright Paul Johnston 2000 - 2009.
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for details.
 */
/* Downloaded 6/1/2012 from the above address by Jeremy White.
    License reproduce here for completeness:

Copyright (c) 1998 - 2009, Paul Johnston & Contributors
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

Neither the name of the author nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */
var hexcase=0,b64pad="",SHA_DIGEST_LENGTH=20,sc=null;$(function(){var e,t="ws://",i=window.location.hostname,n=$("#spice-area").data("port"),a=$("#spice-area").data("password");return i&&n?(e=t+i+":"+n,sc=new SpiceMainConn({uri:e,screen_id:"spice-screen",password:a,onerror:spice_error,onsuccess:spice_success}),void 0):(console.log("must set host and port"),void 0)});