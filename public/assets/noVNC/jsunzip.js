/*
 * JSUnzip
 *
 * Copyright (c) 2011 by Erik Moller
 * All Rights Reserved
 *
 * This software is provided 'as-is', without any express
 * or implied warranty.  In no event will the authors be
 * held liable for any damages arising from the use of
 * this software.
 *
 * Permission is granted to anyone to use this software
 * for any purpose, including commercial applications,
 * and to alter it and redistribute it freely, subject to
 * the following restrictions:
 *
 * 1. The origin of this software must not be
 *    misrepresented; you must not claim that you
 *    wrote the original software. If you use this
 *    software in a product, an acknowledgment in
 *    the product documentation would be appreciated
 *    but is not required.
 *
 * 2. Altered source versions must be plainly marked
 *    as such, and must not be misrepresented as
 *    being the original software.
 *
 * 3. This notice may not be removed or altered from
 *    any source distribution.
 */
function JSUnzip(){this.getInt=function(e,t){switch(t){case 4:return(255&this.data.charCodeAt(e+3))<<24|(255&this.data.charCodeAt(e+2))<<16|(255&this.data.charCodeAt(e+1))<<8|255&this.data.charCodeAt(e+0);case 2:return(255&this.data.charCodeAt(e+1))<<8|255&this.data.charCodeAt(e+0);default:return 255&this.data.charCodeAt(e)}},this.getDOSDate=function(e,t){var i=31&e,n=(15&e>>5)-1,s=1980+(127&e>>9),o=2*(31&t),r=63&t>>5;return hour=31&t>>11,new Date(s,n,i,hour,r,o)},this.open=function(e){if(this.data=e,this.files=[],22>this.data.length)return{status:!1,error:"Invalid data"};for(var t=this.data.length-22;t>=0&&101010256!=this.getInt(t,4);)--t;if(0>t)return{status:!1,error:"Invalid data"};if(0!=this.getInt(t+4,2)||0!=this.getInt(t+6,2))return{status:!1,error:"No multidisk support"};var i=this.getInt(t+8,2),n=this.getInt(t+16,4),s=this.getInt(t+20,2);this.comment=this.data.slice(t+22,t+22+s);for(var o=n,r=0;i>r;++r){if(33639248!=this.getInt(o+0,4))return{status:!1,error:"Invalid data"};if(this.getInt(o+6,2)>20)return{status:!1,error:"Unsupported version"};if(1&this.getInt(o+8,2))return{status:!1,error:"Encryption not implemented"};var a=this.getInt(o+10,2);if(0!=a&&8!=a)return{status:!1,error:"Unsupported compression method"};var l=this.getInt(o+12,2),c=this.getInt(o+14,2),h=this.getDOSDate(c,l);this.getInt(o+16,4);var u=this.getInt(o+20,4),d=this.getInt(o+24,4),f=this.getInt(o+28,2),p=this.getInt(o+30,2),g=this.getInt(o+32,2),m=this.getInt(o+42,4),v=this.data.slice(o+46,o+46+f),_=this.data.slice(o+46+f+p,o+46+f+p+g);if(67324752!=this.getInt(m+0,4))return{status:!1,error:"Invalid data"};var b=this.getInt(m+26,2),C=this.getInt(m+28,2),y=m+30+b+C;this.files[v]={fileComment:_,compressionMethod:a,compressedSize:u,uncompressedSize:d,localFileContent:y,lastModifiedDate:h},o+=46+f+p+g}return{status:!0}},this.read=function(e){var t=this.files[e];if(t){if(8==t.compressionMethod){tinf||(tinf=new TINF,tinf.init());var i=tinf.uncompress(this.data,t.localFileContent);return i.status==tinf.OK?{status:!0,data:i.data}:{status:!1,error:i.error}}return{status:!0,data:this.data.slice(t.localFileContent,t.localFileContent+t.uncompressedSize)}}return{status:!1,error:"File '"+e+"' doesn't exist in zip"}}}function TINF(){this.OK=0,this.DATA_ERROR=-3,this.WINDOW_SIZE=32768,this.TREE=function(){this.table=new Array(16),this.trans=new Array(288)},this.DATA=function(e){this.source="",this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=[],this.history=[],this.ltree=new e.TREE,this.dtree=new e.TREE},this.sltree=new this.TREE,this.sdtree=new this.TREE,this.length_bits=new Array(30),this.length_base=new Array(30),this.dist_bits=new Array(30),this.dist_base=new Array(30),this.clcidx=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],this.build_bits_base=function(e,t,i,n){var s,o;for(s=0;i>s;++s)e[s]=0;for(s=0;30-i>s;++s)e[s+i]=Math.floor(s/i);for(o=n,s=0;30>s;++s)t[s]=o,o+=1<<e[s]},this.build_fixed_trees=function(e,t){var i;for(i=0;7>i;++i)e.table[i]=0;for(e.table[7]=24,e.table[8]=152,e.table[9]=112,i=0;24>i;++i)e.trans[i]=256+i;for(i=0;144>i;++i)e.trans[24+i]=i;for(i=0;8>i;++i)e.trans[168+i]=280+i;for(i=0;112>i;++i)e.trans[176+i]=144+i;for(i=0;5>i;++i)t.table[i]=0;for(t.table[5]=32,i=0;32>i;++i)t.trans[i]=i},this.build_tree=function(e,t,i,n){var s,o,r=new Array(16);for(s=0;16>s;++s)e.table[s]=0;for(s=0;n>s;++s)e.table[t[i+s]]++;for(e.table[0]=0,o=0,s=0;16>s;++s)r[s]=o,o+=e.table[s];for(s=0;n>s;++s)t[i+s]&&(e.trans[r[t[i+s]]++]=s)},this.getbit=function(e){var t;return e.bitcount--||(e.tag=255&e.source[e.sourceIndex++],e.bitcount=7),t=1&e.tag,e.tag>>=1,t},this.read_bits=function(e,t,i){if(!t)return i;for(var n=0;24>e.bitcount;)e.tag=e.tag|(255&e.source[e.sourceIndex++])<<e.bitcount,e.bitcount+=8;return n=e.tag&65535>>16-t,e.tag>>=t,e.bitcount-=t,n+i},this.decode_symbol=function(e,t){for(;16>e.bitcount;)e.tag=e.tag|(255&e.source[e.sourceIndex++])<<e.bitcount,e.bitcount+=8;var i=0,n=0,s=0;do n=2*n+((e.tag&1<<s)>>s),++s,i+=t.table[s],n-=t.table[s];while(n>=0);return e.tag>>=s,e.bitcount-=s,t.trans[i+n]},this.decode_trees=function(e,t,i){var n,s,o,r,a,l,c=new this.TREE,h=new Array(320);for(n=this.read_bits(e,5,257),s=this.read_bits(e,5,1),o=this.read_bits(e,4,4),r=0;19>r;++r)h[r]=0;for(r=0;o>r;++r){var u=this.read_bits(e,3,0);h[this.clcidx[r]]=u}for(this.build_tree(c,h,0,19),a=0;n+s>a;){var d=this.decode_symbol(e,c);switch(d){case 16:var f=h[a-1];for(l=this.read_bits(e,2,3);l;--l)h[a++]=f;break;case 17:for(l=this.read_bits(e,3,3);l;--l)h[a++]=0;break;case 18:for(l=this.read_bits(e,7,11);l;--l)h[a++]=0;break;default:h[a++]=d}}this.build_tree(t,h,0,n),this.build_tree(i,h,n,s)},this.inflate_block_data=function(e,t,i){for(var n=e.dest,s=n.length;;){var o=this.decode_symbol(e,t);if(256==o)return this.OK;if(256>o)n[s++]=o,e.history.push(o);else{var r,a,l,c;if(o-=257,r=this.read_bits(e,this.length_bits[o],this.length_base[o]),a=this.decode_symbol(e,i),l=e.history.length-this.read_bits(e,this.dist_bits[a],this.dist_base[a]),0>l)throw"Invalid zlib offset "+l;for(c=l;l+r>c;++c)n[s++]=e.history[c],e.history.push(e.history[c])}}},this.inflate_uncompressed_block=function(e){var t,i,n;if(e.bitcount>7){var s=Math.floor(e.bitcount/8);e.sourceIndex-=s,e.bitcount=0,e.tag=0}if(t=e.source[e.sourceIndex+1],t=256*t+e.source[e.sourceIndex],i=e.source[e.sourceIndex+3],i=256*i+e.source[e.sourceIndex+2],t!=(65535&~i))return this.DATA_ERROR;for(e.sourceIndex+=4,n=t;n;--n)e.history.push(e.source[e.sourceIndex]),e.dest[e.dest.length]=e.source[e.sourceIndex++];return e.bitcount=0,this.OK},this.inflate_fixed_block=function(e){return this.inflate_block_data(e,this.sltree,this.sdtree)},this.inflate_dynamic_block=function(e){return this.decode_trees(e,e.ltree,e.dtree),this.inflate_block_data(e,e.ltree,e.dtree)},this.init=function(){this.build_fixed_trees(this.sltree,this.sdtree),this.build_bits_base(this.length_bits,this.length_base,4,3),this.build_bits_base(this.dist_bits,this.dist_base,2,1),this.length_bits[28]=0,this.length_base[28]=258,this.reset()},this.reset=function(){this.d=new this.DATA(this),delete this.header},this.uncompress=function(e,t){var i,n=this.d;n.source=e,n.sourceIndex=t,n.bitcount=0,n.dest=[],"undefined"==typeof this.header&&(this.header=this.read_bits(n,16,0));var s=0;do{var o,r;switch(i=this.getbit(n),o=this.read_bits(n,2,0)){case 0:r=this.inflate_uncompressed_block(n);break;case 1:r=this.inflate_fixed_block(n);break;case 2:r=this.inflate_dynamic_block(n);break;default:return{status:this.DATA_ERROR}}if(r!=this.OK)return{status:this.DATA_ERROR};s++}while(!i&&n.sourceIndex<n.source.length);return n.history=n.history.slice(-this.WINDOW_SIZE),{status:this.OK,data:n.dest}}}var tinf;