/*
 * noVNC: HTML5 VNC client
 * Copyright (C) 2011 Joel Martin
 * Licensed under LGPL-3 (see LICENSE.txt)
 *
 * See README.md for usage and integration instructions.
 *
 * TIGHT decoder portion:
 * (c) 2012 Michael Tinglof, Joe Balaz, Les Piech (Mercuri.ca)
 */
function RFB(e){"use strict";function t(){var e,t;for(Util.Debug(">> RFB.constructor"),e=0;N.length>e;e+=1)U[N[e][1]]=U[N[e][0]],O[N[e][1]]=N[e][0],G[N[e][1]]=[0,0];try{z=new Display({target:B.target})}catch(i){Util.Error("Display exception: "+i),a("fatal","No working Display")}return j=new Keyboard({target:B.focusContainer,onKeyPress:w}),W=new Mouse({target:B.target,onMouseButton:S,onMouseMove:F}),t=z.get_render_mode(),H=new Websock,H.on("message",c),H.on("open",function(){"connect"===M?a("ProtocolVersion","Starting VNC handshake"):l("Got unexpected WebSockets connection")}),H.on("close",function(e){e.code&&Util.Info("Close code: "+e.code+", reason: "+e.reason+", wasClean: "+e.wasClean),"disconnect"===M?a("disconnected","VNC disconnected"):"ProtocolVersion"===M?l("Failed to connect to server"):M in{failed:1,disconnected:1}?Util.Error("Received onclose while disconnected"):l("Server disconnected")}),H.on("error",function(e){l("WebSock error: "+e)}),o(),Websock_native?(Util.Info("Using native WebSockets"),a("loaded","noVNC ready: native WebSockets, "+t)):(Util.Warn("Using web-socket-js bridge. Flash version: "+Util.Flash.version),!Util.Flash||9>Util.Flash.version?a("fatal","WebSockets or <a href='http://get.adobe.com/flashplayer'>Adobe Flash</a> is required"):"file://"===document.location.href.substr(0,7)?a("fatal","'file://' URL is incompatible with Adobe Flash"):a("loaded","noVNC ready: WebSockets emulation, "+t)),Util.Debug("<< RFB.constructor"),x}function i(){Util.Debug(">> RFB.connect");var e;"undefined"!=typeof UsingSocketIO?e="http://"+k+":"+T+"/"+$:(e=B.encrypt?"wss://":"ws://",e+=k+":"+T+"/"+$),Util.Info("connecting to "+e),H.open(e),Util.Debug("<< RFB.connect")}function n(e,t){var i,n=[];for(i=0;e.length>i;i+=1)n.push(e.charCodeAt(i));return new DES(n).encrypt(t)}function s(){return ct.length>0?(H.send(ct),setTimeout(function(){H.send(v())},50),ct=[],!0):!1}function r(e){1===Z&&l("Tight protocol handler only implements true color mode");var t,i,n,s,r,o,a=-1,c=0,h=-1,u=H.get_rQ(),d=H.get_rQi();if(V.bytes=1,H.rQwait("TIGHT compression-control",V.bytes))return!1;var f=function(e){for(var t=0;4>t;t++)1&c>>t&&(V.zlibs[t].reset(),Util.Info("Reset zlib stream "+t));var i=V.zlibs[h].uncompress(e,0);return 0!==i.status&&Util.Error("Invalid data in zlib stream"),i.data},p=function(){var e=u[d+2]+1,t=e*Z;if(V.bytes+=t,H.rQwait("TIGHT palette "+i,V.bytes))return!1;var s=2>=e?1:8,r=Math.floor((V.width*s+7)/8),a=!1;if(12>r*V.height?(a=!0,n=[0,r*V.height]):n=A(H.rQslice(3+t,3+t+3)),V.bytes+=n[0]+n[1],H.rQwait("TIGHT "+i,V.bytes))return!1;H.rQshiftBytes(3);var l=H.rQshiftBytes(t);H.rQshiftBytes(n[0]),o=a?H.rQshiftBytes(n[1]):f(H.rQshiftBytes(n[1]));var c,h,p,g,m,v,_,b=[];if(2===e)for(g=Math.floor((V.width+7)/8),m=Math.floor(V.width/8),h=0;V.height>h;h++){for(c=0;m>c;c++)for(p=7;p>=0;p--)v=3*(h*V.width+8*c+7-p),_=3*(1&o[h*g+c]>>p),b[v]=l[_],b[v+1]=l[_+1],b[v+2]=l[_+2];for(p=7;p>=8-V.width%8;p--)v=3*(h*V.width+8*c+7-p),_=3*(1&o[h*g+c]>>p),b[v]=l[_],b[v+1]=l[_+1],b[v+2]=l[_+2]}else for(h=0;V.height>h;h++)for(c=0;V.width>c;c++)v=3*(h*V.width+c),_=3*o[h*V.width+c],b[v]=l[_],b[v+1]=l[_+1],b[v+2]=l[_+2];return V.imgQ.push({type:"rgb",img:{complete:!0,data:b},x:V.x,y:V.y,width:V.width,height:V.height}),!0},g=function(){var e=!1,t=V.width*V.height*Z;return 12>t?(e=!0,n=[0,t]):n=A(H.rQslice(1,4)),V.bytes=1+n[0]+n[1],H.rQwait("TIGHT "+i,V.bytes)?!1:(H.rQshiftBytes(1+n[0]),o=e?H.rQshiftBytes(n[1]):f(H.rQshiftBytes(n[1])),V.imgQ.push({type:"rgb",img:{complete:!0,data:o},x:V.x,y:V.y,width:V.width,height:V.height}),!0)};if(t=H.rQpeek8(),c=15&t,t>>=4,h=3&t,8===t)i="fill";else if(9===t)i="jpeg";else if(10===t)i="png";else if(4&t)i="filter";else{if(!(4>t))throw"Illegal tight compression received, ctl: "+t;i="copy"}if(e&&("filter"===i||"copy"===i))throw"filter/copy received in tightPNG mode";switch(i){case"fill":V.bytes+=Z;break;case"jpeg":V.bytes+=3;break;case"png":V.bytes+=3;break;case"filter":V.bytes+=2;break;case"copy":}if(H.rQwait("TIGHT "+i,V.bytes))return!1;switch(i){case"fill":H.rQshift8(),s=H.rQshiftBytes(Z),V.imgQ.push({type:"fill",img:{complete:!0},x:V.x,y:V.y,width:V.width,height:V.height,color:[s[2],s[1],s[0]]});break;case"png":case"jpeg":if(n=A(H.rQslice(1,4)),V.bytes=1+n[0]+n[1],H.rQwait("TIGHT "+i,V.bytes))return!1;H.rQshiftBytes(1+n[0]),r=new Image,V.imgQ.push({type:"img",img:r,x:V.x,y:V.y}),r.src="data:image/"+i+y(H.rQshiftBytes(n[1])),r=null;break;case"filter":if(a=u[d+1],1!==a)throw"Unsupported tight subencoding received, filter: "+a;if(!p())return!1;break;case"copy":if(!g())return!1}return V.bytes=0,V.rects-=1,!0}var o,a,l,c,h,u,d,f,p,g,m,v,_,b,C,A,y,E,w,S,F,D,x={},B={},k="",T=5900,I="",$="",M="disconnected",L=0,R=3.8,P="",N=[["COPYRECT",1],["TIGHT",7],["TIGHT_PNG",-260],["HEXTILE",5],["RRE",2],["RAW",0],["DesktopSize",-223],["Cursor",-239],["JPEG_quality_med",-26],["compress_hi",-247],["last_rect",-224]],U={},O={},G={},H=null,z=null,j=null,W=null,Y=null,K=null,Q=null,q=null,V={rects:0,subrects:0,lines:0,tiles:0,bytes:0,x:0,y:0,width:0,height:0,encoding:0,subencoding:-1,background:null,imgQ:[],zlibs:[]},X=4,Z=3,J=0,et=0,tt="",it=40,nt=0,st=100,rt={last_fbu:0,fbu_total:0,fbu_total_cnt:0,full_fbu_total:0,full_fbu_cnt:0,fbu_rt_start:0,fbu_rt_total:0,fbu_rt_cnt:0,pixels:0},ot=!1,at=Websock_native?10:25,lt=0,ct=[],ht=!1,ut={};return Util.conf_defaults(B,x,e,[["target","wo","dom",null,"VNC display rendering Canvas object"],["focusContainer","wo","dom",document,"DOM element that captures keyboard input"],["encrypt","rw","bool",!1,"Use TLS/SSL/wss encryption"],["true_color","rw","bool",!0,"Request true color pixel data"],["local_cursor","rw","bool",!1,"Request locally rendered cursor"],["shared","rw","bool",!0,"Request shared mode"],["view_only","rw","bool",!1,"Disable client mouse/keyboard"],["connectTimeout","rw","int",at,"Time (s) to wait for connection"],["disconnectTimeout","rw","int",10,"Time (s) to wait for disconnection"],["viewportDrag","rw","bool",!1,"Move the viewport on mouse drags"],["check_rate","rw","int",217,"Timing (ms) of send/receive check"],["fbu_req_rate","rw","int",1413,"Timing (ms) of frameBufferUpdate requests"],["onUpdateState","rw","func",function(){},"onUpdateState(rfb, state, oldstate, statusMsg): RFB state update/change "],["onPasswordRequired","rw","func",function(){},"onPasswordRequired(rfb): VNC password is required "],["onClipboard","rw","func",function(){},"onClipboard(rfb, text): RFB clipboard contents received"],["onBell","rw","func",function(){},"onBell(rfb): RFB Bell message received "],["onFBUReceive","rw","func",function(){},"onFBUReceive(rfb, fbu): RFB FBU received but not yet processed "],["onFBUComplete","rw","func",function(){},"onFBUComplete(rfb, fbu): RFB FBU received and processed "],["updateState","rw","func",function(){},"obsolete, use onUpdateState"],["clipboardReceive","rw","func",function(){},"obsolete, use onClipboard"]]),x.set_local_cursor=function(e){!e||e in{0:1,no:1,"false":1}?B.local_cursor=!1:z.get_cursor_uri()?B.local_cursor=!0:Util.Warn("Browser does not support local cursor")},x.get_display=function(){return z},x.get_keyboard=function(){return j},x.get_mouse=function(){return W},o=function(){var e;for(H.init(),V.rects=0,V.subrects=0,V.lines=0,V.tiles=0,V.imgQ=[],V.zlibs=[],lt=0,ct=[],e=0;N.length>e;e+=1)G[N[e][1]][0]=0;for(e=0;4>e;e++)V.zlibs[e]=new TINF,V.zlibs[e].init()},f=function(){var e,t;for(Util.Info("Encoding stats for this connection:"),e=0;N.length>e;e+=1)t=G[N[e][1]],t[0]+t[1]>0&&Util.Info("    "+N[e][0]+": "+t[0]+" rects");for(Util.Info("Encoding stats since page load:"),e=0;N.length>e;e+=1)t=G[N[e][1]],t[0]+t[1]>0&&Util.Info("    "+N[e][0]+": "+t[1]+" rects")},a=function(e,t){var n,s,r=M;if(e===r)return Util.Debug("Already in state '"+e+"', ignoring."),void 0;switch(e in{disconnected:1,loaded:1,connect:1,disconnect:1,failed:1,fatal:1}&&(Y&&(clearInterval(Y),Y=null),q&&(clearInterval(q),q=null),z&&z.get_context()&&(j.ungrab(),W.ungrab(),z.defaultCursor(),("debug"!==Util.get_logging()||"loaded"===e)&&z.clear()),H.close()),"fatal"===r&&Util.Error("Fatal error, cannot continue"),n="failed"===e||"fatal"===e?Util.Error:Util.Warn,M="failed"===r&&"disconnected"===e?"failed":e,s="undefined"!=typeof t?" Msg: "+t:"",n("New state '"+M+"', was '"+r+"'."+s),K&&"connect"!==M&&(Util.Debug("Clearing connect timer"),clearInterval(K),K=null),Q&&"disconnect"!==M&&(Util.Debug("Clearing disconnect timer"),clearInterval(Q),Q=null),e){case"normal":("disconnected"===r||"failed"===r)&&Util.Error("Invalid transition from 'disconnected' or 'failed' to 'normal'");break;case"connect":K=setTimeout(function(){l("Connect timeout")},1e3*B.connectTimeout),o(),i();break;case"disconnect":ot||(Q=setTimeout(function(){l("Disconnect timeout")},1e3*B.disconnectTimeout)),f();break;case"failed":"disconnected"===r&&Util.Error("Invalid transition from 'disconnected' to 'failed'"),"normal"===r&&Util.Error("Error while connected."),"init"===r&&Util.Error("Error while initializing."),setTimeout(function(){a("disconnected")},50);break;default:}"failed"===r&&"disconnected"===e?(B.updateState(x,e,r),B.onUpdateState(x,e,r)):(B.updateState(x,e,r,t),B.onUpdateState(x,e,r,t))},l=function(e){return a("failed",e),!1},c=function(){if(0===H.rQlen())return Util.Warn("handle_message called on empty receive queue"),void 0;switch(M){case"disconnected":case"failed":Util.Error("Got data while disconnected");break;case"normal":u()&&H.rQlen()>0&&(null===q?(Util.Debug("More data to process, creating timer"),q=setTimeout(function(){q=null,c()},10)):Util.Debug("More data to process, existing timer"));break;default:h()}},D=function(){var e;"normal"!==M||ht||s()||(e=(new Date).getTime(),e>nt+B.fbu_req_rate&&(nt=e,H.send(v()))),setTimeout(D,B.check_rate)},w=function(e,t){var i;B.view_only||(i=_(e,t),i=i.concat(v()),H.send(i))},S=function(e,t,i,n){if(i?lt|=n:lt^=n,B.viewportDrag){if(i&&!ht)return ht=!0,ut={x:e,y:t},void 0;ht=!1,H.send(v())}B.view_only||(ct=ct.concat(b(z.absX(e),z.absY(t))),s())},F=function(e,t){var i,n;return ht?(i=ut.x-e,n=ut.y-t,ut={x:e,y:t},z.viewportChange(i,n),void 0):(B.view_only||(ct=ct.concat(b(z.absX(e),z.absY(t)))),void 0)},h=function(){var e,t,i,s,r,o,c,u,d,f,m,_,b,C,A,y,w,S,F,k,T;switch(M){case"ProtocolVersion":if(12>H.rQlen())return l("Incomplete protocol version");switch(s=H.rQshiftStr(12).substr(4,7),Util.Info("Server ProtocolVersion: "+s),s){case"003.003":L=3.3;break;case"003.006":L=3.3;break;case"003.007":L=3.7;break;case"003.008":L=3.8;break;case"004.000":L=3.8;break;default:return l("Invalid server version "+s)}L>R&&(L=R),ot||(Y=setInterval(function(){H.flush()},50)),r="00"+parseInt(L,10)+".00"+10*L%10,H.send_string("RFB "+r+"\n"),a("Security","Sent ProtocolVersion: "+r);break;case"Security":if(L>=3.7){if(u=H.rQshift8(),H.rQwait("security type",u,1))return!1;if(0===u)return e=H.rQshift32(),t=H.rQshiftStr(e),l("Security failure: "+t);for(P=0,c=H.rQshiftBytes(u),Util.Debug("Server security types: "+c),o=0;c.length>o;o+=1)c[o]>P&&3>c[o]&&(P=c[o]);if(0===P)return l("Unsupported security types: "+c);H.send([P])}else{if(H.rQwait("security scheme",4))return!1;P=H.rQshift32()}a("Authentication","Authenticating using scheme: "+P),h();break;case"Authentication":switch(P){case 0:return H.rQwait("auth reason",4)?!1:(e=H.rQshift32(),t=H.rQshiftStr(e),l("Auth failure: "+t));case 1:if(L>=3.8)return a("SecurityResult"),void 0;break;case 2:return 0===I.length?(a("password","Password Required"),B.onPasswordRequired(x),void 0):H.rQwait("auth challenge",16)?!1:(d=H.rQshiftBytes(16),f=n(I,d),H.send(f),a("SecurityResult"),void 0);default:return l("Unsupported auth scheme: "+P),void 0}a("ClientInitialisation","No auth required"),h();break;case"SecurityResult":if(H.rQwait("VNC auth response ",4))return!1;switch(H.rQshift32()){case 0:break;case 1:if(L>=3.8){if(i=H.rQshift32(),H.rQwait("SecurityResult reason",i,8))return!1;t=H.rQshiftStr(i),l(t)}else l("Authentication failed");return;case 2:return l("Too many auth attempts")}a("ClientInitialisation","Authentication OK"),h();break;case"ClientInitialisation":H.send([B.shared?1:0]),a("ServerInitialisation","Authentication OK");break;case"ServerInitialisation":if(H.rQwait("server initialization",24))return!1;J=H.rQshift16(),et=H.rQshift16(),m=H.rQshift8(),_=H.rQshift8(),b=H.rQshift8(),k=H.rQshift8(),C=H.rQshift16(),A=H.rQshift16(),y=H.rQshift16(),w=H.rQshift8(),S=H.rQshift8(),F=H.rQshift8(),H.rQshiftStr(3),Util.Info("Screen: "+J+"x"+et+", bpp: "+m+", depth: "+_+", big_endian: "+b+", true_color: "+k+", red_max: "+C+", green_max: "+A+", blue_max: "+y+", red_shift: "+w+", green_shift: "+S+", blue_shift: "+F),0!==b&&Util.Warn("Server native endian is not little endian"),16!==w&&Util.Warn("Server native red-shift is not 16"),0!==F&&Util.Warn("Server native blue-shift is not 0"),T=H.rQshift32(),tt=H.rQshiftStr(T),B.true_color&&"Intel(r) AMT KVM"===tt&&(Util.Warn("Intel AMT KVM only support 8/16 bit depths. Disabling true color"),B.true_color=!1),z.set_true_color(B.true_color),z.resize(J,et),j.grab(),W.grab(),B.true_color?(X=4,Z=3):(X=1,Z=1),f=p(),f=f.concat(g()),f=f.concat(v()),rt.fbu_rt_start=(new Date).getTime(),H.send(f),setTimeout(D,B.check_rate),setTimeout(E,it),B.encrypt?a("normal","Connected (encrypted) to: "+tt):a("normal","Connected (unencrypted) to: "+tt)}},u=function(){var e,t,i,n,s,r,o,a,c,h=!0;switch(e=V.rects>0?0:H.rQshift8()){case 0:h=d();break;case 1:if(Util.Debug("SetColourMapEntries"),H.rQshift8(),s=H.rQshift16(),r=H.rQshift16(),H.rQwait("SetColourMapEntries",6*r,6))return!1;for(n=0;r>n;n+=1)o=H.rQshift16(),o=parseInt(o/256,10),a=parseInt(H.rQshift16()/256,10),c=parseInt(H.rQshift16()/256,10),z.set_colourMap([c,a,o],s+n);Util.Debug("colourMap: "+z.get_colourMap()),Util.Info("Registered "+r+" colourMap entries");break;case 2:Util.Debug("Bell"),B.onBell(x);break;case 3:if(Util.Debug("ServerCutText"),H.rQwait("ServerCutText header",7,1))return!1;if(H.rQshiftBytes(3),t=H.rQshift32(),H.rQwait("ServerCutText",t,8))return!1;i=H.rQshiftStr(t),B.clipboardReceive(x,i),B.onClipboard(x,i);break;default:l("Disconnected: illegal server message type "+e),Util.Debug("ws.rQslice(0,30):"+H.rQslice(0,30))}return h},d=function(){var e,t,i,n=!0;if(0===V.rects){if(H.rQwait("FBU header",3))return H.rQunshift8(0),!1;H.rQshift8(),V.rects=H.rQshift16(),V.bytes=0,rt.cur_fbu=0,rt.fbu_rt_start>0&&(e=(new Date).getTime(),Util.Info("First FBU latency: "+(e-rt.fbu_rt_start)))}for(;V.rects>0;){if("normal"!==M)return!1;if(H.rQwait("FBU",V.bytes))return!1;if(0===V.bytes){if(H.rQwait("rect header",12))return!1;if(t=H.rQshiftBytes(12),V.x=(t[0]<<8)+t[1],V.y=(t[2]<<8)+t[3],V.width=(t[4]<<8)+t[5],V.height=(t[6]<<8)+t[7],V.encoding=parseInt((t[8]<<24)+(t[9]<<16)+(t[10]<<8)+t[11],10),B.onFBUReceive(x,{x:V.x,y:V.y,width:V.width,height:V.height,encoding:V.encoding,encodingName:O[V.encoding]}),!O[V.encoding])return l("Disconnected: unsupported encoding "+V.encoding),!1}if(rt.last_fbu=(new Date).getTime(),n=U[V.encoding](),e=(new Date).getTime(),rt.cur_fbu+=e-rt.last_fbu,n&&(G[V.encoding][0]+=1,G[V.encoding][1]+=1,rt.pixels+=V.width*V.height),(0===V.rects||rt.pixels>=J*et)&&((V.width===J&&V.height===et||rt.fbu_rt_start>0)&&(rt.full_fbu_total+=rt.cur_fbu,rt.full_fbu_cnt+=1,Util.Info("Timing of full FBU, cur: "+rt.cur_fbu+", total: "+rt.full_fbu_total+", cnt: "+rt.full_fbu_cnt+", avg: "+rt.full_fbu_total/rt.full_fbu_cnt)),rt.fbu_rt_start>0&&(i=e-rt.fbu_rt_start,rt.fbu_rt_total+=i,rt.fbu_rt_cnt+=1,Util.Info("full FBU round-trip, cur: "+i+", total: "+rt.fbu_rt_total+", cnt: "+rt.fbu_rt_cnt+", avg: "+rt.fbu_rt_total/rt.fbu_rt_cnt),rt.fbu_rt_start=0)),!n)return n}return B.onFBUComplete(x,{x:V.x,y:V.y,width:V.width,height:V.height,encoding:V.encoding,encodingName:O[V.encoding]}),!0},U.RAW=function(){var e,t;return 0===V.lines&&(V.lines=V.height),V.bytes=V.width*X,H.rQwait("RAW",V.bytes)?!1:(e=V.y+(V.height-V.lines),t=Math.min(V.lines,Math.floor(H.rQlen()/(V.width*X))),z.blitImage(V.x,e,V.width,t,H.get_rQ(),H.get_rQi()),H.rQshiftBytes(V.width*t*X),V.lines-=t,V.lines>0?V.bytes=V.width*X:(V.rects-=1,V.bytes=0),!0)},U.COPYRECT=function(){var e,t;return H.rQwait("COPYRECT",4)?!1:(e=H.rQshift16(),t=H.rQshift16(),z.copyImage(e,t,V.x,V.y,V.width,V.height),V.rects-=1,V.bytes=0,!0)},U.RRE=function(){var e,t,i,n,s,r;if(0===V.subrects){if(H.rQwait("RRE",4+X))return!1;V.subrects=H.rQshift32(),e=H.rQshiftBytes(X),z.fillRect(V.x,V.y,V.width,V.height,e)}for(;V.subrects>0&&H.rQlen()>=X+8;)e=H.rQshiftBytes(X),t=H.rQshift16(),i=H.rQshift16(),n=H.rQshift16(),s=H.rQshift16(),z.fillRect(V.x+t,V.y+i,n,s,e),V.subrects-=1;return V.subrects>0?(r=Math.min(st,V.subrects),V.bytes=(X+8)*r):(V.rects-=1,V.bytes=0),!0},U.HEXTILE=function(){var e,t,i,n,s,r,o,a,c,h,u,d,f,p,g,m,v,_=H.get_rQ(),b=H.get_rQi();for(0===V.tiles&&(V.tiles_x=Math.ceil(V.width/16),V.tiles_y=Math.ceil(V.height/16),V.total_tiles=V.tiles_x*V.tiles_y,V.tiles=V.total_tiles);V.tiles>0;){if(V.bytes=1,H.rQwait("HEXTILE subencoding",V.bytes))return!1;if(e=_[b],e>30)return l("Disconnected: illegal hextile subencoding "+e),!1;if(t=0,n=V.total_tiles-V.tiles,s=n%V.tiles_x,a=Math.floor(n/V.tiles_x),r=V.x+16*s,c=V.y+16*a,o=Math.min(16,V.x+V.width-r),h=Math.min(16,V.y+V.height-c),1&e)V.bytes+=o*h*X;else if(2&e&&(V.bytes+=X),4&e&&(V.bytes+=X),8&e){if(V.bytes+=1,H.rQwait("hextile subrects header",V.bytes))return!1;t=_[b+V.bytes-1],V.bytes+=16&e?t*(X+2):2*t}if(H.rQwait("hextile",V.bytes))return!1;if(V.subencoding=_[b],b+=1,0===V.subencoding)1&V.lastsubencoding?Util.Debug("     Ignoring blank after RAW"):z.fillRect(r,c,o,h,V.background);else if(1&V.subencoding)z.blitImage(r,c,o,h,_,b),b+=V.bytes-1;else{if(2&V.subencoding&&(V.background=_.slice(b,b+X),b+=X),4&V.subencoding&&(V.foreground=_.slice(b,b+X),b+=X),z.startTile(r,c,o,h,V.background),8&V.subencoding)for(t=_[b],b+=1,d=0;t>d;d+=1)16&V.subencoding?(i=_.slice(b,b+X),b+=X):i=V.foreground,u=_[b],b+=1,f=u>>4,p=15&u,g=_[b],b+=1,m=(g>>4)+1,v=(15&g)+1,z.subTile(f,p,m,v,i);z.finishTile()}H.set_rQi(b),V.lastsubencoding=V.subencoding,V.bytes=0,V.tiles-=1}return 0===V.tiles&&(V.rects-=1),!0},A=function(e){var t=1,i=0;return i+=127&e[0],128&e[0]&&(t+=1,i+=(127&e[1])<<7,128&e[1]&&(t+=1,i+=e[2]<<14)),[t,i]},y=function(e){return";base64,"+Base64.encode(e)},E=function(){var e,t,i;if(i=z.get_context(),"normal"===M){for(t=V.imgQ;t.length>0&&t[0].img.complete;)e=t.shift(),"fill"===e.type?z.fillRect(e.x,e.y,e.width,e.height,e.color):"rgb"===e.type?z.blitRgbImage(e.x,e.y,e.width,e.height,e.img.data,0):i.drawImage(e.img,e.x,e.y);setTimeout(E,it)}},U.TIGHT=function(){return r(!1)},U.TIGHT_PNG=function(){return r(!0)},U.last_rect=function(){return Util.Debug(">> set_desktopsize"),V.rects=0,Util.Debug("<< set_desktopsize"),!0},U.DesktopSize=function(){return Util.Debug(">> set_desktopsize"),J=V.width,et=V.height,z.resize(J,et),rt.fbu_rt_start=(new Date).getTime(),H.send(v()),V.bytes=0,V.rects-=1,Util.Debug("<< set_desktopsize"),!0},U.Cursor=function(){var e,t,i,n,s,r;return e=V.x,t=V.y,i=V.width,n=V.height,s=i*n*X,r=Math.floor((i+7)/8)*n,V.bytes=s+r,H.rQwait("cursor encoding",V.bytes)?!1:(z.changeCursor(H.rQshiftBytes(s),H.rQshiftBytes(r),e,t,i,n),V.bytes=0,V.rects-=1,!0)},U.JPEG_quality_lo=function(){Util.Error("Server sent jpeg_quality pseudo-encoding")},U.compress_lo=function(){Util.Error("Server sent compress level pseudo-encoding")},p=function(){var e;return e=[0],e.push8(0),e.push8(0),e.push8(0),e.push8(8*X),e.push8(8*Z),e.push8(0),e.push8(B.true_color?1:0),e.push16(255),e.push16(255),e.push16(255),e.push8(16),e.push8(8),e.push8(0),e.push8(0),e.push8(0),e.push8(0),e},g=function(){var e,t,i=[];for(t=0;N.length>t;t+=1)"Cursor"!==N[t][0]||B.local_cursor?i.push(N[t][1]):Util.Debug("Skipping Cursor pseudo-encoding");for(e=[2],e.push8(0),e.push16(i.length),t=0;i.length>t;t+=1)e.push32(i[t]);return e},m=function(e,t,i,n,s){"undefined"==typeof t&&(t=0),"undefined"==typeof i&&(i=0),"undefined"==typeof n&&(n=J),"undefined"==typeof s&&(s=et);var r;return r=[3],r.push8(e),r.push16(t),r.push16(i),r.push16(n),r.push16(s),r},v=function(){var e,t,i,n=z.getCleanDirtyReset(),s=[];for(t=n.cleanBox,t.w>0&&t.h>0&&(s=s.concat(m(1,t.x,t.y,t.w,t.h))),e=0;n.dirtyBoxes.length>e;e++)i=n.dirtyBoxes[e],s=s.concat(m(0,i.x,i.y,i.w,i.h));return s},_=function(e,t){var i;return i=[4],i.push8(t),i.push16(0),i.push32(e),i},b=function(e,t){var i;return i=[5],i.push8(lt),i.push16(e),i.push16(t),i},C=function(e){var t,i,n;for(t=[6],t.push8(0),t.push8(0),t.push8(0),t.push32(e.length),n=e.length,i=0;n>i;i+=1)t.push(e.charCodeAt(i));return t},x.connect=function(e,t,i,n){return k=e,T=t,I=void 0!==i?i:"",$=void 0!==n?n:"",k&&T?(a("connect"),void 0):l("Must set host and port")},x.disconnect=function(){a("disconnect","Disconnecting")},x.sendPassword=function(e){I=e,M="Authentication",setTimeout(h,1)},x.sendCtrlAltDel=function(){if("normal"!==M||B.view_only)return!1;Util.Info("Sending Ctrl-Alt-Del");var e=[];e=e.concat(_(65507,1)),e=e.concat(_(65513,1)),e=e.concat(_(65535,1)),e=e.concat(_(65535,0)),e=e.concat(_(65513,0)),e=e.concat(_(65507,0)),e=e.concat(v()),H.send(e)},x.sendKey=function(e,t){if("normal"!==M||B.view_only)return!1;var i=[];"undefined"!=typeof t?(Util.Info("Sending key code ("+(t?"down":"up")+"): "+e),i=i.concat(_(e,t?1:0))):(Util.Info("Sending key code (down + up): "+e),i=i.concat(_(e,1)),i=i.concat(_(e,0))),i=i.concat(v()),H.send(i)},x.clipboardPasteFrom=function(e){"normal"===M&&H.send(C(e))},x.testMode=function(e){ot=!0,x.recv_message=H.testMode(e),D=function(){},x.connect=function(e,t,i){k=e,T=t,I=i,a("ProtocolVersion","Starting VNC handshake")}},t()}