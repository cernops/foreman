function computeResourceSelected(e){var t=$(e).val(),n=attribute_hash(["architecture_id","compute_resource_id","operatingsystem_id"]);if(""==t)$("#mac_address").show(),$("#model_name").show(),$("#compute_resource").empty(),$("#vm_details").empty(),$("#compute_resource_tab").hide(),update_capabilities("build");else{$("#mac_address").hide(),$("#model_name").hide(),$("#compute_resource_tab").show(),$("#vm_details").empty();var i=$(e).attr("data-url");$.ajax({type:"post",url:i,data:n,success:function(e){$("#compute_resource").html(e),update_capabilities($("#capabilities").val())}})}}function update_capabilities(e){var t=/build/i.test(e),n=/image/i.test(e);t?($("#manage_network").show(),$("#host_provision_method_build").click()):($("#manage_network").hide(),$("#host_provision_method_image").click()),t&&n?$("#provisioning_method").show():$("#provisioning_method").hide(),$("#image_provisioning").empty(),$("#image_selection").appendTo($("#image_provisioning")),update_provisioning_image()}function submit_host(e){var t=window.location.pathname.replace(/\/edit$|\/new$/,"");return/\/clone$/.test(window.location.pathname)&&(t=foreman_url("/hosts")),$("#host_submit").attr("disabled",!0),stop_pooling=!1,$("body").css("cursor","progress"),clear_errors(),animate_progress(),$.ajax({type:"POST",url:t,data:e.serialize(),success:function(e){e.redirect?window.location.replace(e.redirect):($("#host-progress").hide(),$("#content").replaceWith($("#content",e)),onContentLoad(),onHostEditLoad())},error:function(e){$("#content").html(e.responseText)},complete:function(){stop_pooling=!0,$("body").css("cursor","auto"),$("#host_submit").attr("disabled",!1)}}),!1}function clear_errors(){$(".error").children().children(".help-inline").remove(),$(".error").removeClass("error"),$(".tab-error").removeClass("tab-error"),$(".alert-error").remove()}function animate_progress(){1!=stop_pooling&&setTimeout(function(){var e=$("#host_progress_report_id").val();$.get("/tasks/"+e,function(e){update_progress(e),animate_progress()})},1600)}function update_progress(e){var t=$("p",e).size();if(0!=t&&1!=stop_pooling){var n=$(".icon-check",e).size(),i=$(".icon-remove",e).size(),a=$(".progress");$("#host-progress").show(),i>0?a.removeClass("progress-success").addClass("progress-danger"):a.removeClass("progress-danger").addClass("progress-success"),$(".bar").width(n/t*a.width()),$("#tasks_progress").replaceWith(e)}}function filter_puppet_classes(e){var t=$(e).val().trim();$(".puppetclass_group li.puppetclass.hide").addClass("hide-me"),t.length>0?($(".puppetclass_group li.puppetclass").removeClass("filter-marker").hide(),$(".puppetclass_group li.puppetclass:not(.hide-me, .selected-marker) span:contains("+t+")").parent("li").addClass("filter-marker").show()):$(".puppetclass_group li.puppetclass:not(.hide-me, .selected-marker)").addClass("filter-marker").show();var n=$("li.filter-marker").closest(".puppetclass_group");$(".puppetclass_group").hide(),n.show()}function add_puppet_class(e){var t=$(e).attr("data-class-id"),n=$(e).attr("data-type");$(e).tooltip("hide");var i=$(e).parent().clone();i.attr("id","selected_puppetclass_"+t),i.append("<input id='"+n+"_puppetclass_ids_' name='"+n+"[puppetclass_ids][]' type='hidden' value="+t+">"),i.children("span").tooltip();var a=i.children("a");a.attr("onclick","remove_puppet_class(this)"),a.attr("data-original-title","Click to undo adding this class"),a.removeClass("icon-plus-sign").addClass("icon-remove-sign").tooltip(),$("#selected_classes").append(i),$("#selected_puppetclass_"+t).show("highlight",5e3),$("#puppetclass_"+t).addClass("selected-marker").hide(),load_puppet_class_parameters(a)}function remove_puppet_class(e){var t=$(e).attr("data-class-id");return $("#puppetclass_"+t).removeClass("selected-marker").show(),$("#puppetclass_"+t).closest(".puppetclass_group").show(),$("#selected_puppetclass_"+t).children("a").tooltip("hide"),$("#selected_puppetclass_"+t).remove(),$("#puppetclass_"+t+"_params_loading").remove(),$('[id^="puppetclass_'+t+'_params\\["]').remove(),$("#params-tab").removeClass("tab-error"),$("#params").find(".control-group.error").length>0&&$("#params-tab").addClass("tab-error"),!1}function load_puppet_class_parameters(e){var t=$(e).attr("data-class-id");if(!($("#puppetclass_"+t+"_params_loading").length>0||$('[id^="#puppetclass_'+t+'_params\\["]').length>0)){var n=$(e).attr("data-url"),i=$("form").serialize().replace("method=put","method=post");if(void 0!=n){var a=$('<tr id="puppetclass_'+t+'_params_loading">'+'<td colspan="5"><p><img src="/assets/spinner.gif" alt="Wait" /> Loading parameters...</p></td>'+"</tr>");$("#inherited_puppetclasses_parameters").append(a),$.ajax({url:n,type:"post",data:i,success:function(e){var t=$(e);a.replaceWith(t),t.find('a[rel="popover"]').popover(),t.find(".error").length>0&&$("#params-tab").addClass("tab-error")}})}}}function hostgroup_changed(e){var t=$(e).data("host-id");t?update_puppetclasses(e):update_form(e)}function organization_changed(e){update_form(e)}function location_changed(e){update_form(e)}function update_form(e){var t=$(e).data("url"),n=$("form").serialize().replace("method=put","method=post"),i=$(e).parent().find("img");i.show(),$.ajax({type:"post",url:t,data:n,success:function(e){$("form").html(e),$("[id$='subnet_id']").first().change(),onContentLoad()},complete:function(){i.hide()}})}function subnet_selected(e){var t=$(e).val();if(""!=t&&0!=$("#host_ip").size()){var n=$(e).children(":selected").text();if(0!=n.length&&-1!=n.search(/^.+ \([0-9\.\/]+\)/)){var i=n.replace(/^.+\(/,"").replace(")","").split("/");if(subnet_contains(i[0],i[1],$("#host_ip").val()))return}var a=attribute_hash(["subnet_id","host_mac","organization_id","location_id"]);$("#subnet_indicator").show();var o=$(e).data("url");$.ajax({data:a,type:"post",url:o,complete:function(){$("#subnet_indicator").hide()},success:function(e){$("#host_ip").val(e.ip)}})}}function subnet_contains(e,t,n){var i=_to_int(n),a=_to_int(e),o=32-parseInt(t);return i>>o==a>>o}function _to_int(e){for(var t=e.split("."),n=0,i=0;3>=i;i++)n=256*n+parseInt(t[i]);return n}function domain_selected(e){var t=attribute_hash(["domain_id","organization_id","location_id"]),n=$(e).data("url");$("#domain_indicator").show(),$.ajax({data:t,type:"post",url:n,complete:function(){$("#domain_indicator").hide()},success:function(e){$("#subnet_select").html(e),reload_params()}})}function architecture_selected(e){var t=attribute_hash(["architecture_id","organization_id","location_id"]),n=$(e).attr("data-url");$.ajax({data:t,type:"post",url:n,success:function(e){$("#os_select").html(e)}})}function os_selected(e){var t=attribute_hash(["operatingsystem_id","organization_id","location_id"]),n=$(e).attr("data-url");$.ajax({data:t,type:"post",url:n,success:function(e){$("#media_select").html(e),reload_params()}}),update_provisioning_image()}function update_provisioning_image(){var e=$('[id$="_compute_resource_id"]').val(),t=$('[id$="_architecture_id"]').val(),n=$('[id$="_operatingsystem_id"]').val();if(void 0!=e&&""!=e&&""!=t&&""!=n){var i="operatingsystem="+n+" architecture="+t,a=$("[id$=compute_attributes_image_id]").empty();$.ajax({data:"search="+encodeURIComponent(i),type:"get",url:foreman_url("/compute_resources/"+e+"/images"),dataType:"json",success:function(e){$.each(e,function(){a.append($("<option />").val(this.image.uuid).text(this.image.name))}),a.find("option").length>0&&a.attr("disabled",!1)}})}}function medium_selected(e){var t=$(e).attr("data-url"),n=$(e).attr("data-type"),i="hosts"==n?"host":"hostgroup",a={};a[i]=attribute_hash(["medium_id","operatingsystem_id","architecture_id"]),a[i].use_image="checked"==$("*[id*=use_image]").attr("checked"),$.ajax({data:a,type:"post",url:t,success:function(e){$("#image_details").html(e)}})}function use_image_selected(e){var t=$(e).attr("data-url"),n=$(e).attr("data-type"),i="hosts"==n?"host":"hostgroup",a={};a[i]=attribute_hash(["medium_id","operatingsystem_id","architecture_id","model_id"]),a[i].use_image="checked"==$(e).attr("checked"),$.ajax({data:a,type:"post",url:t,success:function(e){var t=$("*[id*=image_file]");a[i].use_image?""==t.val()&&t.val(e.image_file):t.val(""),t.attr("disabled",!a[i].use_image)}})}function override_param(e){var t=$(e).closest("tr"),n=t.find("[id^=name_]").text(),i=t.find("[id^=value_]").val();$("#parameters").find(".btn-success").click();var a=t.closest(".tab-pane").find("[id*=host_host_parameters]:visible").last().parent();a.find("[id$=_name]").val(n),a.find("[id$=_value]").val(i),mark_params_override()}function override_class_param(e){var t=$(e).closest('tr[id^="puppetclass_"][id*="_params\\["][id$="\\]"]'),n=t.attr("id").replace(/puppetclass_\d+_params\[(\d+)\]/,"$1"),i=t.find("[data-property=class]").text(),a=t.find("[data-property=name]").text(),o=t.find("[data-property=value]").val(),s=t.find("[data-property=type]").text();$("#puppetclasses_parameters").find(".btn-success").click();var r=t.closest(".tab-pane").find("[id*=host_lookup_values]:visible").last().parent();r.find("[data-property=lookup_key_id]").val(n),r.find("[data-property=class]").val(i),r.find("[data-property=name]").val(a),r.find("[data-property=value]").val(o),r.find("[data-property=type]").val(s),mark_params_override()}function reload_params(){var e=$("#params-tab").data("url"),t=$("[data-submit='progress_bar']").serialize().replace("method=put","method=post");load_with_placeholder("inherited_parameters",e,t);var n=$("#params-tab").data("url2");load_with_placeholder("inherited_puppetclasses_parameters",n,t)}function load_with_placeholder(e,t,n){if(void 0!=t){var i=$('<tr id="'+e+'_loading" >'+'<td colspan="4"><p><img src="/assets/spinner.gif" alt="Wait" /> Loading parameters...</p></td></tr>');$("#"+e+" tbody").replaceWith(i),$.ajax({type:"post",url:t,data:n,success:function(t){i.closest("#"+e).replaceWith($(t)),mark_params_override()}})}}function onHostEditLoad(){$("#host-conflicts-modal").modal({show:"true",backdrop:"static"}),$("#host-conflicts-modal").click(function(){$("#host-conflicts-modal").modal("hide")});var e=$("[data-submit='progress_bar']");e.on("submit",function(){return submit_host(e),!1}),$("#host_provision_method_build").on("click",function(){$("#network_provisioning").show(),$("#image_provisioning").hide()}),$("#host_provision_method_image").on("click",function(){$("#network_provisioning").hide(),$("#image_provisioning").show()}),$("#image_selection").appendTo($("#image_provisioning")),$("#params-tab").on("shown",function(){mark_params_override()})}function interface_domain_selected(e){var t=e.value,n=$(e).parentsUntil(".fields").parent().find("[id$=_subnet_id]").empty(),i=$(e).parent().find(".indicator");if(n.attr("disabled",!0),""==t)return n.append($("<option />").val(null).text("No subnets")),!1;i.removeClass("hide");var a=$(e).attr("data-url"),o=$("#host_organization_id :selected").val(),s=$("#host_location_id :selected").val();$.ajax({data:{domain_id:t,organization_id:o,location_id:s},type:"post",url:a,dataType:"json",success:function(e){e.length>1&&n.append($("<option />").val(null).text("Please select")),$.each(e,function(){n.append($("<option />").val(this.subnet.id).text(this.subnet.name+" ("+this.subnet.to_label+")"))}),n.find("option").length>0?(n.attr("disabled",!1),n.change()):(n.append($("<option />").text("No subnets")),n.attr("disabled",!0)),i.addClass("hide")}})}function interface_subnet_selected(e){var t=$(e).val();if(""!=t){var n=$(e).parent().find(".indicator"),i=$(e).parentsUntil(".fields").parent().find("input[id$=_ip]");i.attr("disabled",!0),n.removeClass("hide");var a=$(e).children(":selected").text();if(0!=a.length&&-1!=a.search(/^.+ \([0-9\.\/]+\)/)){var o=a.replace(/^.+\(/,"").replace(")","").split("/"),s=o[0],r=o[1];if(subnet_contains(s,r,i.val()))return i.attr("disabled",!1),n.addClass("hide"),void 0}var l=$(e).parentsUntil(".fields").parent().find("input[id$=_mac]"),c=$(e).attr("data-url"),u=$("#host_organization_id :selected").val(),d=$("#host_location_id :selected").val(),h={subnet_id:t,host_mac:l.val(),organization_id:u,location_id:d};$.ajax({data:h,type:"post",url:c,dataType:"json",success:function(e){i.val(e.ip)},complete:function(){n.addClass("hide"),i.attr("disabled",!1)}})}}function interface_type_selected(e){var t=$(e).find("option:selected").text(),n=$(e).parentsUntil(".fields").parent().find("#bmc_fields");"BMC"==t?(n.find("input:disabled").prop("disabled",!1),n.removeClass("hide")):(n.find("input").prop("disabled",!0),n.addClass("hide"))}var stop_pooling;$(function(){onHostEditLoad()}),$(document).on("change",".interface_domain",function(){interface_domain_selected(this)}),$(document).on("change",".interface_subnet",function(){interface_subnet_selected(this)}),$(document).on("change",".interface_type",function(){interface_type_selected(this)});